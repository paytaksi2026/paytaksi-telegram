<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi • Driver</title>
<link rel="stylesheet" href="/style.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head><body>
<div class="header"><span class="title">PayTaksi</span><span class="badge">Driver</span></div>
<div class="wrap">

  <div class="card" id="regCard" style="display:none">
    <div class="kpi" style="font-size:18px">Sürücü Qeydiyyatı</div>
    <p class="small">İlk dəfə daxil olanda bu formanı doldur. Admin təsdiqləyəndən sonra sifariş ala biləcəksən.</p>

    <div class="row">
      <input class="input" id="fn" placeholder="Ad"/>
      <input class="input" id="ln" placeholder="Soyad"/>
    </div>
    <div class="row" style="margin-top:10px">
      <input class="input" id="phone" placeholder="+994 XX XXX XX XX" inputmode="tel"/>
    </div>

    <hr/>
    <div class="row">
      <input class="input" id="car_make" placeholder="Avtomobil markası"/>
      <input class="input" id="car_model" placeholder="Avtomobil modeli"/>
    </div>
    <div class="row" style="margin-top:10px">
      <input class="input" id="plate" placeholder="Avtomobil nömrəsi (məs: 10-AA-123)"/>
    </div>

    <hr/>
    <div class="small">Sənədlər (şəkil):</div>
    <div class="row" style="margin-top:10px">
      <label class="small" style="width:100%">Avtomobil şəkli<input class="input" id="doc_car" type="file" accept="image/*"></label>
      <label class="small" style="width:100%">Sürücülük vəsiqəsi<input class="input" id="doc_license" type="file" accept="image/*"></label>
      <label class="small" style="width:100%">Şəxsiyyət vəsiqəsi<input class="input" id="doc_id" type="file" accept="image/*"></label>
      <label class="small" style="width:100%">Tex pasport (ön)<input class="input" id="doc_tech_f" type="file" accept="image/*"></label>
      <label class="small" style="width:100%">Tex pasport (arxa)<input class="input" id="doc_tech_b" type="file" accept="image/*"></label>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnReg">Qeydiyyatı göndər</button>
    </div>
    <div class="small" id="regMsg"></div>
  </div>

  <div class="card" id="blockCard" style="display:none">
    <div class="kpi" style="font-size:18px;color:#fecaca">Sifariş bloklandı</div>
    <p class="small" id="blockReason">-</p>
  </div>

  <div class="card" id="appCard" style="display:none">
    <div class="row">
      <button class="btn" id="btnOnline">Online ol</button>
      <button class="btn secondary" id="btnOffline" disabled>Offline ol</button>
      <button class="btn secondary" id="btnWaze" disabled>Waze</button>
    </div>
    <div class="small">Balans: <b id="bal">-</b> AZN</div>
    <div class="small">Status: <span id="st">-</span></div>
    <hr/>
    <div id="map"></div>
  </div>

  <div class="card" id="reqCard" style="display:none">
    <div class="kpi" style="font-size:18px">Gələn sifariş</div>
    <div class="small" id="req">Sifariş gözlənilir...</div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnAccept" disabled>Qəbul et</button>
      <button class="btn secondary" id="btnArrived" disabled>Çatdım</button>
      <button class="btn secondary" id="btnStart" disabled>Başla</button>
      <button class="btn danger" id="btnFinish" disabled>Bitir</button>
    </div>
  </div>

  <div class="card" id="topupCard" style="display:none">
    <div class="kpi" style="font-size:18px">Balans artır (qəbz)</div>
    <div class="row">
      <input class="input" id="topAmount" type="number" step="0.01" placeholder="Məbləğ (AZN)"/>
      <input class="input" id="topFile" type="file" accept="image/*"/>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnTopup">Qəbzi göndər</button>
    </div>
    <div class="small" id="topMsg"></div>
  </div>
</div>

<div class="bigPrice" id="bigPrice">
  <div class="box">
    <div class="small">Müştəridən alınacaq</div>
    <div class="amount" id="bigAmount">0.00 AZN</div>
    <button class="btn" id="btnCloseBig">Bağla</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
const user = tg?.initDataUnsafe?.user || null;

let map, meMarker;
let online=false;
let currentTripId=null;
let lastPickup=null;

function setSt(t){ document.getElementById('st').textContent=t; }
function setBal(v){ document.getElementById('bal').textContent = Number(v).toFixed(2); }
function show(id,on){ document.getElementById(id).style.display = on?'block':'none'; }
function showBlock(showIt, reason){
  show('blockCard', showIt);
  document.getElementById('blockReason').textContent = reason||'';
}

async function upsertDriverBase(){
  if(!user) return;
  await fetch('/api/users/upsert', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id:user.id, role:'driver', first_name:user.first_name, last_name:user.last_name})});
}

async function getMe(){
  const r = await fetch('/api/driver/me?driver_id='+user.id);
  return await r.json();
}

function initMap(){
  map = L.map('map').setView([40.4093,49.8671], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
}

const socket = io();
socket.on('connect', async ()=>{
  if(!user){ alert("Bu səhifəni botun içindən (Open) aç."); return; }
  await upsertDriverBase();
  const me = await getMe();

  const needReg = !me.phone || !me.car_make || !me.car_model || !me.plate;
  show('regCard', needReg);
  show('appCard', !needReg);
  show('reqCard', !needReg);
  show('topupCard', !needReg);

  if(needReg){
    document.getElementById('fn').value = user.first_name||'';
    document.getElementById('ln').value = user.last_name||'';
    return;
  }

  setBal(me.balance);
  setSt(me.status);
  if(me.blocked) showBlock(true, me.block_reason); else showBlock(false,'');
  initMap();
});

socket.on('trip:request', (p)=>{
  if(!online) return;
  currentTripId = p.trip_id;
  lastPickup = p.pickup;
  document.getElementById('req').textContent = `Trip: ${p.trip_id} | sərnişin: ${p.passenger_id}`;
  document.getElementById('btnAccept').disabled = false;
});

socket.on('driver:balance:update', (p)=>{
  if(p.driver_id !== user?.id) return;
  setBal(p.balance);
  if(p.blocked) showBlock(true, p.block_reason); else showBlock(false,'');
});

navigator.geolocation.watchPosition((pos)=>{
  if(!online || !user) return;
  const lat=pos.coords.latitude, lng=pos.coords.longitude;
  if(!meMarker){ meMarker=L.marker([lat,lng]).addTo(map).bindPopup("Sən"); map.setView([lat,lng], 15); }
  else meMarker.setLatLng([lat,lng]);
  socket.emit('driver:location', {driver_id:user.id, lat, lng, speed:pos.coords.speed, heading:pos.coords.heading, trip_id: currentTripId});
}, ()=>{}, {enableHighAccuracy:true, maximumAge:2000});

document.getElementById('btnReg').onclick = async ()=>{
  const first_name = document.getElementById('fn').value.trim();
  const last_name = document.getElementById('ln').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const car_make = document.getElementById('car_make').value.trim();
  const car_model = document.getElementById('car_model').value.trim();
  const plate = document.getElementById('plate').value.trim();

  if(!first_name || !last_name) return document.getElementById('regMsg').textContent="Ad və soyad yaz.";
  if(!phone.startsWith('+994')) return document.getElementById('regMsg').textContent="Telefon +994 ilə başlamalıdır.";
  if(!car_make || !car_model || !plate) return document.getElementById('regMsg').textContent="Maşın məlumatlarını doldur.";

  const docs = [
    ['car_photo', document.getElementById('doc_car').files[0]],
    ['license', document.getElementById('doc_license').files[0]],
    ['id_card', document.getElementById('doc_id').files[0]],
    ['tech_front', document.getElementById('doc_tech_f').files[0]],
    ['tech_back', document.getElementById('doc_tech_b').files[0]],
  ];
  for(const [t,f] of docs){
    if(!f) return document.getElementById('regMsg').textContent="Bütün sənəd şəkillərini yüklə.";
  }

  const r = await fetch('/api/driver/register', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id:user.id, first_name, last_name, phone, car_make, car_model, plate})});
  const data = await r.json();
  if(!data.ok) return document.getElementById('regMsg').textContent="Xəta: "+(data.error||"");

  for(const [doc_type, file] of docs){
    const fd = new FormData();
    fd.append('driver_id', user.id);
    fd.append('doc_type', doc_type);
    fd.append('file', file);
    const rr = await fetch('/api/driver/docs/upload', {method:'POST', body: fd});
    const dd = await rr.json();
    if(!dd.ok) return document.getElementById('regMsg').textContent="Sənəd yükləmə xətası: "+(dd.error||"");
  }

  document.getElementById('regMsg').textContent="Göndərildi ✅ (Admin təsdiqi gözlənilir)";
  setTimeout(()=> location.reload(), 800);
};

document.getElementById('btnOnline').onclick = async ()=>{
  const me = await (await fetch('/api/driver/set_online', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({driver_id:user.id, is_online:true})})).json();
  if(!me.ok) return alert(me.error||'');
  online=true; setBal(me.balance);
  document.getElementById('btnOnline').disabled=true;
  document.getElementById('btnOffline').disabled=false;
  setSt("online");
};
document.getElementById('btnOffline').onclick = async ()=>{
  await fetch('/api/driver/set_online', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({driver_id:user.id, is_online:false})});
  online=false;
  document.getElementById('btnOnline').disabled=false;
  document.getElementById('btnOffline').disabled=true;
  document.getElementById('btnAccept').disabled=true;
  setSt("offline");
};
document.getElementById('btnAccept').onclick = async ()=>{
  const r = await fetch('/api/trips/accept', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({trip_id:currentTripId, driver_id:user.id})});
  const data = await r.json();
  if(!data.ok) return alert(data.error||'');
  document.getElementById('btnAccept').disabled=true;
  document.getElementById('btnArrived').disabled=false;
  document.getElementById('btnWaze').disabled=false;
  setSt("assigned");
};
document.getElementById('btnWaze').onclick = ()=>{
  if(!lastPickup) return;
  window.open(`https://waze.com/ul?ll=${lastPickup.lat},${lastPickup.lng}&navigate=yes`, "_blank");
};
document.getElementById('btnArrived').onclick = async ()=>{
  await fetch('/api/trips/status', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({trip_id:currentTripId, driver_id:user.id, status:'arrived'})});
  document.getElementById('btnArrived').disabled=true;
  document.getElementById('btnStart').disabled=false;
  setSt("arrived");
};
document.getElementById('btnStart').onclick = async ()=>{
  await fetch('/api/trips/status', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({trip_id:currentTripId, driver_id:user.id, status:'in_trip'})});
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnFinish').disabled=false;
  setSt("in_trip");
};
document.getElementById('btnFinish').onclick = async ()=>{
  const r = await fetch('/api/trips/finish', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({trip_id:currentTripId, driver_id:user.id})});
  const data = await r.json();
  if(!data.ok) return alert(data.error||'');
  document.getElementById('bigAmount').textContent = Number(data.price_azn).toFixed(2)+" AZN";
  document.getElementById('bigPrice').style.display='flex';
  setBal(data.driver_balance);
  currentTripId=null;
  document.getElementById('btnFinish').disabled=true;
  document.getElementById('btnWaze').disabled=true;
  setSt("finished");
  document.getElementById('req').textContent="Sifariş gözlənilir...";
};
document.getElementById('btnCloseBig').onclick = ()=> document.getElementById('bigPrice').style.display='none';

document.getElementById('btnTopup').onclick = async ()=>{
  const amount = Number(document.getElementById('topAmount').value||0);
  const file = document.getElementById('topFile').files[0];
  if(!amount || !file) return alert("Məbləğ və qəbz şəkli lazımdır.");
  const fd=new FormData();
  fd.append('driver_id', user.id);
  fd.append('amount', amount);
  fd.append('receipt', file);
  const r = await fetch('/api/topup/create', {method:'POST', body: fd});
  const data = await r.json();
  document.getElementById('topMsg').textContent = data.ok ? "Göndərildi (pending)." : ("Xəta: "+(data.error||""));
};

if(tg) tg.expand();
</script>
</body></html>
