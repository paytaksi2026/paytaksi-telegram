<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi • Admin</title>
<link rel="stylesheet" href="/style.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head><body>
<div class="header"><span class="title">PayTaksi</span><span class="badge">Admin</span></div>
<div class="wrap">
  <div class="card">
    <div class="kpi" style="font-size:18px">Canlı sürücülər xəritədə</div>
    <div id="map"></div>
  </div>
  <div class="card">
    <div class="kpi" style="font-size:18px">Sürücü təsdiqləri</div>
    <button class="btn secondary" id="btnLoadDrivers">Yenilə</button>
    <div id="drivers"></div>
  </div>
  <div class="card">
    <div class="kpi" style="font-size:18px">Topup qəbzləri</div>
    <button class="btn secondary" id="btnLoadTopups">Yenilə</button>
    <div id="topups"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
const user = tg?.initDataUnsafe?.user || null;

let map; const markers=new Map();
function initMap(){
  map=L.map('map').setView([40.4093,49.8671],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
}
async function upsertAdmin(){
  if(!user) return;
  await fetch('/api/users/upsert',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id:user.id,role:'admin',first_name:user.first_name,last_name:user.last_name})});
}
const socket=io();
socket.on('connect', async ()=>{ await upsertAdmin(); socket.emit('admin:join',{admin_id:user?.id}); });
socket.on('admin:driver_location',(p)=>{
  const key=String(p.driver_id);
  if(!markers.has(key)) markers.set(key, L.marker([p.lat,p.lng]).addTo(map).bindPopup("Driver "+p.driver_id));
  else markers.get(key).setLatLng([p.lat,p.lng]);
});

document.getElementById('btnLoadDrivers').onclick = async ()=>{
  const r=await fetch('/api/admin/pending_drivers?admin_id='+user?.id);
  const data=await r.json();
  const box=document.getElementById('drivers'); box.innerHTML='';
  if(!data.ok) return box.textContent=data.error||'Xəta';
  data.items.forEach(d=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<b>${d.user_id}</b> • status: ${d.status}<br/><span class="small">balance: ${Number(d.balance).toFixed(2)} | plate: ${d.plate||'-'}</span>
    <div class="row" style="margin-top:10px">
      <button class="btn" data-act="approved">Approve</button>
      <button class="btn danger" data-act="rejected">Reject</button>
    </div>`;
    div.querySelectorAll('button').forEach(btn=>{
      btn.onclick=async ()=>{
        await fetch('/api/admin/driver_status',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({admin_id:user?.id,driver_id:d.user_id,status:btn.dataset.act})});
        document.getElementById('btnLoadDrivers').click();
      };
    });
    box.appendChild(div);
  });
};

document.getElementById('btnLoadTopups').onclick = async ()=>{
  const r=await fetch('/api/admin/topups?admin_id='+user?.id);
  const data=await r.json();
  const box=document.getElementById('topups'); box.innerHTML='';
  if(!data.ok) return box.textContent=data.error||'Xəta';
  data.items.forEach(t=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<b>#${t.id}</b> • driver: ${t.driver_id} • <b>${Number(t.amount).toFixed(2)} AZN</b><br/>
    <a class="small" href="${t.receipt_file_url}" target="_blank">Qəbzi aç</a> • status: ${t.status}
    <div class="row" style="margin-top:10px">
      <button class="btn" data-act="approve">Approve</button>
      <button class="btn danger" data-act="reject">Reject</button>
    </div>`;
    div.querySelectorAll('button').forEach(btn=>{
      btn.onclick=async ()=>{
        await fetch('/api/admin/topup_decide',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({admin_id:user?.id,topup_id:t.id,decision:btn.dataset.act})});
        document.getElementById('btnLoadTopups').click();
      };
    });
    box.appendChild(div);
  });
};

initMap();
if(tg) tg.expand();
</script>
</body></html>
