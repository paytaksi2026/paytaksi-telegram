<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi • Passenger</title>
<link rel="stylesheet" href="/style.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
.suggest{margin-top:8px;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden}
.suggest button{width:100%;text-align:left;background:transparent;border:0;color:#e5e7eb;padding:10px 12px;font-size:14px}
.suggest button:hover{background:rgba(255,255,255,.06)}
</style>
</head><body>
<div class="header"><span class="title">PayTaksi</span><span class="badge">Passenger</span></div>

<div class="wrap">
  <div class="card" id="regCard" style="display:none">
    <div class="kpi" style="font-size:18px">Qeydiyyat</div>
    <p class="small">Sifariş vermək üçün bir dəfə qeydiyyat et.</p>
    <div class="row">
      <input class="input" id="fn" placeholder="Ad"/>
      <input class="input" id="ln" placeholder="Soyad"/>
    </div>
    <div class="row" style="margin-top:10px">
      <input class="input" id="phone" placeholder="+994 XX XXX XX XX" inputmode="tel"/>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnReg">Qeydiyyatı tamamla</button>
    </div>
    <div class="small" id="regMsg"></div>
  </div>

  <div class="card" id="appCard" style="display:none">

    <div class="row">
      <button class="btn" id="btnLocate">Mənim lokasiyam</button>
      <button class="btn secondary" id="btnNew">Yeni sifariş</button>
    </div>

    <div class="card" style="margin-top:12px; background:#0b1220; border:1px solid rgba(255,255,255,.08)">
      <div class="small">Haradan (pickup)</div>
      <div class="row" style="margin-top:8px">
        <input class="input" id="pickupTxt" placeholder="Ünvan yazın (məs: Yasamal, Abbas Mirzə...)"/>
      </div>
      <div class="suggest" id="pickupSug" style="display:none"></div>

      <div class="small" style="margin-top:10px">Haraya (drop)</div>
      <div class="row" style="margin-top:8px">
        <input class="input" id="dropTxt" placeholder="Ünvan yazın (məs: 34-cü Polis Şöbəsi)"/>
      </div>
      <div class="suggest" id="dropSug" style="display:none"></div>

      <div class="small" style="margin-top:10px" id="status">Pickup və Drop seç.</div>
    </div>

    <div id="map" style="margin-top:12px"></div>
    <hr/>
    <div class="row">
      <div style="flex:1;min-width:220px"><div class="small">Məsafə (km)</div><div class="kpi" id="km">-</div></div>
      <div style="flex:1;min-width:220px"><div class="small">Qiymət (AZN)</div><div class="kpi" id="price">-</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnOrder" disabled>Sifariş ver</button>
      <button class="btn danger" id="btnCancel" disabled>Ləğv et</button>
    </div>

</div>

  <div class="card" id="liveCard" style="display:none">
    <div class="kpi" style="font-size:18px">Canlı sürücü</div>
    <div class="small" id="driverInfo">-</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
const user = tg?.initDataUnsafe?.user || null;

let map, meMarker, dropMarker, driverMarker, pickup=null, drop=null, tripId=null;
let km=0, price=0;


function setStatus(t){ document.getElementById('status').textContent=t; }
function setKPI(){ document.getElementById('km').textContent = km ? km.toFixed(2) : '-';
                  document.getElementById('price').textContent = price ? price.toFixed(2) : '-'; }

async function geocode(q){
  const r = await fetch('/api/geocode/search?q='+encodeURIComponent(q));
  const d = await r.json();
  return d.items || [];
}
function renderSug(el, items, onPick){
  if(!items.length){ el.style.display='none'; el.innerHTML=''; return; }
  el.style.display='block';
  el.innerHTML = items.map((it,i)=>`<button type="button" data-i="${i}">${it.display}</button>`).join('');
  el.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=> onPick(items[Number(b.dataset.i)]);
  });
}

async function recalc(){
  if(!pickup || !drop){ km=0; price=0; setKPI(); document.getElementById('btnOrder').disabled=true; return; }
  setStatus("Hesablanır...");
  const r = await fetch('/api/pricing/estimate', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({pickup, drop})});
  const data = await r.json();
  km = data.distance_km || 0;
  price = data.price_azn || 0;
  setKPI();
  document.getElementById('btnOrder').disabled=false;
  setStatus("Hazırdır. 'Sifariş ver' bas.");
}

function placePickup(){
  if(!pickup) return;
  if(meMarker) map.removeLayer(meMarker);
  meMarker = L.marker([pickup.lat, pickup.lng]).addTo(map).bindPopup("Pickup").openPopup();
}
function placeDrop(){
  if(!drop) return;
  if(dropMarker) map.removeLayer(dropMarker);
  dropMarker = L.marker([drop.lat, drop.lng]).addTo(map).bindPopup("Drop").openPopup();
}

function initMap(){
  map = L.map('map').setView([40.4093,49.8671], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

  map.on('click', async (e)=>{
    // map click sets DROP by default
    drop = {lat:e.latlng.lat, lng:e.latlng.lng};
    placeDrop();
    await recalc();
  });
}

    drop = {lat:e.latlng.lat, lng:e.latlng.lng};
    if(dropMarker) map.removeLayer(dropMarker);
    dropMarker = L.marker([drop.lat, drop.lng]).addTo(map).bindPopup("Drop").openPopup();
    setStatus("Hesablanır...");
    const r = await fetch('/api/pricing/estimate', {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({pickup, drop})});
    const data = await r.json();
    km = data.distance_km || 0;
    price = data.price_azn || 0;
    setKPI();
    document.getElementById('btnOrder').disabled = false;
    setStatus("Hazırdır. 'Sifariş ver' bas.");
  });
}

document.getElementById('btnLocate').onclick = ()=>{
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    pickup = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    placePickup();
    map.setView([pickup.lat,pickup.lng], 15);
    document.getElementById('pickupTxt').value = "Mənim lokasiyam";
    setStatus("Drop ünvanını yaz və ya xəritədə seç.");
    await recalc();
  }, ()=> setStatus("Lokasiya icazəsi verilmədi."), {enableHighAccuracy:true});
};

document.getElementById('btnNew').onclick = ()=>{
  tripId=null; drop=null; km=0; price=0; setKPI();
  document.getElementById('btnOrder').disabled = true;
  document.getElementById('btnCancel').disabled = true;
  document.getElementById('driverInfo').textContent='-';
  if(dropMarker){ map.removeLayer(dropMarker); dropMarker=null; }
  if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; }
  setStatus("Yeni sifariş: Pickup və Drop ünvanını yaz (və ya xəritədən drop seç).");
};

document.getElementById('btnOrder').onclick = async ()=>{
  const r = await fetch('/api/trips/create', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({passenger_id:user.id, pickup, drop})});
  const data = await r.json();
  if(!data.ok){ setStatus("Sifariş alınmadı: "+(data.error||"")); return; }
  tripId = data.trip_id;
  document.getElementById('btnCancel').disabled = false;
  document.getElementById('btnOrder').disabled = true;
  setStatus("Sürücü axtarılır...");
  socket.emit('passenger:join_trip', {trip_id: tripId, passenger_id: user.id});
};

document.getElementById('btnCancel').onclick = async ()=>{
  if(!tripId) return;
  await fetch('/api/trips/cancel', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({trip_id:tripId, passenger_id: user?.id})});
  setStatus("Ləğv edildi.");
  document.getElementById('btnCancel').disabled = true;
  tripId=null;
};

document.getElementById('btnReg').onclick = async ()=>{
  const first_name = document.getElementById('fn').value.trim();
  const last_name = document.getElementById('ln').value.trim();
  const phone = document.getElementById('phone').value.trim();
  if(!first_name || !last_name) return document.getElementById('regMsg').textContent="Ad və soyad yaz.";
  if(!phone.startsWith('+994')) return document.getElementById('regMsg').textContent="Telefon +994 ilə başlamalıdır.";
  const r = await fetch('/api/passenger/register', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id:user.id, first_name, last_name, phone})});
  const data = await r.json();
  document.getElementById('regMsg').textContent = data.ok ? "Qeydiyyat tamamlandı ✅" : ("Xəta: "+(data.error||""));
  if(data.ok){
    show('regCard', false);
    show('appCard', true);
    show('liveCard', true);
    initMap();
  }
};

const socket = io();
socket.on('connect', async ()=>{
  if(!user){ alert("Bu səhifəni botun içindən (Open) aç."); return; }
  await upsertPassenger();
  const me = await getMe();
  const needReg = !me.phone;
  show('regCard', needReg);
  show('appCard', !needReg);
  show('liveCard', !needReg);
  if(needReg){
    document.getElementById('fn').value = user.first_name||'';
    document.getElementById('ln').value = user.last_name||'';
  } else {
    initMap();
  }
});

socket.on('trip:assigned', (p)=>{
  if(p.trip_id !== tripId) return;
  setStatus("Sürücü qəbul etdi. Gəlir...");
  document.getElementById('driverInfo').textContent = `Sürücü ID: ${p.driver_id}`;
});
socket.on('trip:status:update', (p)=>{
  if(p.trip_id !== tripId) return;
  setStatus("Status: "+p.status);
});
socket.on('driver:location:update', (p)=>{
  if(!tripId || p.trip_id !== tripId) return;
  const {lat,lng} = p;
  if(!driverMarker){
    driverMarker = L.marker([lat,lng]).addTo(map).bindPopup("Driver");
  } else {
    driverMarker.setLatLng([lat,lng]);
  }
});

if(tg) tg.expand();
</script>
</body></html>
