<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi Admin</title>
  <style>
    :root{--bg:#0b0f0c;--card:#111815;--muted:#9fb0a6;--text:#e8f1ec;--accent:#2bd66f;--border:rgba(255,255,255,.08);--danger:#ff5d5d}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btnP{background:var(--accent);color:#04150b}
    .btnS{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btnD{background:var(--danger);color:#1a0000}
    .input{width:100%;background:#0f1512;border:1px solid var(--border);border-radius:12px;padding:10px 12px;color:var(--text);outline:none}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left}
    th{color:var(--muted);font-size:12px}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px;display:inline-block}
    a{color:var(--text)}
    .tabs button{margin-right:8px}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="loginCard">
      <h2 style="margin:0 0 10px">Admin giriş</h2>
      <div style="color:var(--muted);margin-bottom:12px">Yalnız sürücü təsdiqi üçün.</div>
      <div class="row">
        <input class="input" id="u" placeholder="username" />
        <input class="input" id="p" placeholder="password" type="password" />
        <button class="btn btnP" id="login">Daxil ol</button>
      </div>
      <div id="err" style="color:var(--danger);margin-top:10px"></div>
      <div style="color:var(--muted);margin-top:10px;font-size:12px">Admin Login parol :)))))))).</div>
    </div>

    <div class="card hide" id="mainCard">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 style="margin:0 0 6px">Sürücü təsdiqi</h2>
          <div class="pill" id="who"></div>
        </div>
        <button class="btn btnS" id="logout">Çıxış</button>
      </div>

      <div class="tabs" style="margin-top:12px">
        <button class="btn btnS" data-st="PENDING">Pending</button>
        <button class="btn btnS" data-st="APPROVED">Approved</button>
        <button class="btn btnS" data-st="REJECTED">Rejected</button>
        <button class="btn btnS" data-st="BLOCKED">Blocked</button>
      </div>

      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Ad</th><th>Telefon</th><th>Maşın</th><th>Nömrə</th><th>Status</th><th>Sənədlər</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
let token = localStorage.getItem('admin_token') || '';
let status = 'PENDING';

async function api(path, opts={}){
  const headers = opts.headers || {};
  if(token) headers.Authorization = 'Bearer '+token;
  if(!headers['Content-Type']) headers['Content-Type']='application/json';
  const res = await fetch(path, {...opts, headers});
  const txt = await res.text();
  let j=null; try{j=txt?JSON.parse(txt):null}catch{j={raw:txt}};
  if(!res.ok) throw Object.assign(new Error('API'), {status:res.status, data:j});
  return j;
}

function show(id){
  document.getElementById('loginCard').classList.add('hide');
  document.getElementById('mainCard').classList.remove('hide');
}
function showLogin(){
  document.getElementById('loginCard').classList.remove('hide');
  document.getElementById('mainCard').classList.add('hide');
}

async function load(){
  const out = await api(`/api/admin/drivers?status=${encodeURIComponent(status)}`);
  const tb = document.getElementById('rows');
  tb.innerHTML='';
  for(const d of out.items){
    const tr = document.createElement('tr');
    const docs = d.docs?.license_front_url ? `<a href="${d.docs.license_front_url}" target="_blank">LF</a> | <a href="${d.docs.license_back_url}" target="_blank">LB</a> | <a href="${d.docs.car_doc_url}" target="_blank">CD</a>` : '-';
    tr.innerHTML = `
      <td>${d.user_id}</td>
      <td>${d.name}</td>
      <td>${d.phone}</td>
      <td>${d.car_model||''}</td>
      <td>${d.car_plate||''}</td>
      <td><span class="pill">${d.approval_status}</span></td>
      <td>${docs}</td>
      <td></td>
    `;
    const td = tr.lastElementChild;
    if(status==='PENDING'){
      const ap = document.createElement('button'); ap.className='btn btnP'; ap.textContent='Approve';
      ap.onclick=async()=>{ await api(`/api/admin/driver/${d.user_id}/approve`, {method:'POST'}); await load(); };
      const rj = document.createElement('button'); rj.className='btn btnD'; rj.textContent='Reject';
      rj.onclick=async()=>{ await api(`/api/admin/driver/${d.user_id}/reject`, {method:'POST'}); await load(); };
      const bl = document.createElement('button'); bl.className='btn btnS'; bl.textContent='Block';
      bl.onclick=async()=>{ await api(`/api/admin/driver/${d.user_id}/block`, {method:'POST'}); await load(); };
      td.appendChild(ap); td.appendChild(document.createTextNode(' ')); td.appendChild(rj); td.appendChild(document.createTextNode(' ')); td.appendChild(bl);
    } else {
      const bl = document.createElement('button'); bl.className='btn btnS'; bl.textContent='Block';
      bl.onclick=async()=>{ await api(`/api/admin/driver/${d.user_id}/block`, {method:'POST'}); await load(); };
      td.appendChild(bl);
    }
    tb.appendChild(tr);
  }
}

document.getElementById('login').onclick = async()=>{
  document.getElementById('err').textContent='';
  try{
    const username=document.getElementById('u').value.trim();
    const password=document.getElementById('p').value;
    const out = await api('/api/admin/login', {method:'POST', body: JSON.stringify({username,password})});
    token = out.token;
    localStorage.setItem('admin_token', token);
    document.getElementById('who').textContent = 'Admin: '+out.admin.username;
    show();
    await load();
  }catch(e){
    document.getElementById('err').textContent = e.data?.error || 'Login error';
  }
};

document.getElementById('logout').onclick=()=>{
  token='';
  localStorage.removeItem('admin_token');
  showLogin();
};

for(const b of document.querySelectorAll('.tabs button')){
  b.onclick=async()=>{ status=b.dataset.st; await load(); };
}

if(token){
  document.getElementById('who').textContent='Admin';
  show();
  load().catch(()=>{ token=''; localStorage.removeItem('admin_token'); showLogin(); });
}
</script>
</body>
</html>
