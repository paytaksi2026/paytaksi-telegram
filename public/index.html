<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PayTaksi</title>
<style>
body { background:#0f172a; color:#e5e7eb; font-family:Arial; text-align:center; padding-top:40px; margin:0;}
.container{max-width:560px;margin:0 auto;padding:0 14px;}
.card { background:rgba(15,23,42,.75); border:1px solid rgba(148,163,184,.2); border-radius:14px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
h2{margin:0 0 12px 0}
select,input,button { padding:12px; margin:6px 0; width:100%; border-radius:10px; border:1px solid rgba(148,163,184,.25); background:rgba(2,6,23,.55); color:#e5e7eb; box-sizing:border-box;}
button { background:#22c55e; color:#081014; border:none; font-weight:700; cursor:pointer;}
button.secondary{background:rgba(148,163,184,.15); color:#e5e7eb; border:1px solid rgba(148,163,184,.25);}
.row{display:flex; gap:10px;}
.msg{min-height:22px;margin-top:10px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(148,163,184,.10);font-size:12px}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="card" id="authCard">
    <h2>PayTaksi</h2>

    <select id="role">
      <option value="passenger">Müştəri</option>
      <option value="driver">Sürücü</option>
    </select>

    <input id="phone" placeholder="Telefon (+994...)" autocomplete="tel">
    <input id="password" type="password" placeholder="Şifrə" autocomplete="current-password">
    <input id="name" placeholder="Ad Soyad (qeydiyyat üçün)" autocomplete="name">

    <div class="row">
      <button onclick="registerUser()">Qeydiyyat</button>
      <button class="secondary" onclick="loginUser()">Daxil ol</button>
    </div>

    <p class="msg" id="msg"></p>
  </div>

  <div class="card hidden" id="dashCard">
    <h2 id="dashTitle">Panel</h2>
    <div id="driverPanel" class="hidden">
      <p><span class="badge" id="driverState">OFFLINE</span></p>
      <div class="row">
        <button onclick="goOnline()">Online ol</button>
        <button class="secondary" onclick="goOffline()">Offline ol</button>
      </div>
      <p class="msg" id="driverMsg"></p>
    </div>

    <div id="passengerPanel" class="hidden">
      <p class="badge">Müştəri paneli</p>
      <p style="opacity:.8;margin-top:10px">Növbəti mərhələdə: xəritə + sifariş sistemi.</p>
    </div>

    <div style="margin-top:16px">
      <button class="secondary" onclick="logout()">Çıxış</button>
    </div>
  </div>
</div>

<script>
let session = null; // {role, phone, password, name, is_online}

function setMsg(t){ document.getElementById('msg').textContent = t || ''; }
function setDriverMsg(t){ document.getElementById('driverMsg').textContent = t || ''; }

function showDash(){
  authCard.classList.add('hidden');
  dashCard.classList.remove('hidden');
  dashTitle.textContent = session.role === 'driver' ? ('Sürücü paneli: ' + (session.name||'')) : ('Müştəri paneli: ' + (session.name||''));
  passengerPanel.classList.toggle('hidden', session.role !== 'passenger');
  driverPanel.classList.toggle('hidden', session.role !== 'driver');
  if(session.role === 'driver'){
    refreshDriverState(session.is_online || 0);
  }
}

function showAuth(){
  dashCard.classList.add('hidden');
  authCard.classList.remove('hidden');
  setMsg('');
  setDriverMsg('');
  session = null;
}

function refreshDriverState(isOnline){
  const el = document.getElementById('driverState');
  if(isOnline){
    el.textContent = 'ONLINE';
    el.style.background = 'rgba(34,197,94,.15)';
  }else{
    el.textContent = 'OFFLINE';
    el.style.background = 'rgba(148,163,184,.10)';
  }
}

async function registerUser(){
  setMsg('...');
  const res = await fetch('/api/register', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      phone:phone.value,
      password:password.value,
      role:role.value,
      name:name.value
    })
  });
  const data = await res.json();
  if(data.success){
    if(role.value === 'driver'){
      setMsg('Hörmətli ' + (name.value||'') + ', sürücü qeydiyyatı tamamlandı. Admin təsdiqi gözlənilir.');
    }else{
      setMsg('Hörmətli ' + (name.value||'') + ', siz qeydiyyatdan keçdiniz. İndi "Daxil ol" edin.');
    }
  } else {
    if(data.error === 'PHONE_ROLE_EXISTS') setMsg('Bu telefon bu rol üçün artıq qeydiyyatdan keçib. "Daxil ol" edin.');
    else setMsg(data.error || 'ERROR');
  }
}

async function loginUser(){
  setMsg('...');
  const res = await fetch('/api/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      phone:phone.value,
      password:password.value,
      role:role.value
    })
  });
  const data = await res.json();
  if(data.pending){
    setMsg('Sürücü hesabı admin təsdiqi gözləyir.');
    return;
  }
  if(data.success){
    setMsg('');
    session = { role: role.value, phone: phone.value, password: password.value, name: data.name || name.value || '', is_online: data.is_online || 0 };
    showDash();
  } else {
    setMsg(data.error || 'ERROR');
  }
}

async function goOnline(){
  setDriverMsg('...');
  const res = await fetch('/api/driver/online', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ phone: session.phone, password: session.password })
  });
  const data = await res.json();
  if(data.success){
    session.is_online = 1;
    refreshDriverState(1);
    setDriverMsg('Online oldunuz.');
  } else {
    if(data.error === 'DRIVER_NOT_APPROVED') setDriverMsg('Admin təsdiqi yoxdur.');
    else setDriverMsg(data.error || 'ERROR');
  }
}

async function goOffline(){
  setDriverMsg('...');
  const res = await fetch('/api/driver/offline', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ phone: session.phone, password: session.password })
  });
  const data = await res.json();
  if(data.success){
    session.is_online = 0;
    refreshDriverState(0);
    setDriverMsg('Offline oldunuz.');
  } else {
    setDriverMsg(data.error || 'ERROR');
  }
}

function logout(){
  // simple client-side logout
  showAuth();
}
</script>

</body>
</html>
