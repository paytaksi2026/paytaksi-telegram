<!doctype html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PayTaksi</title>
<style>
  body{background:#0b1220;color:#e5e7eb;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
  .card{width:min(560px,92vw);background:rgba(15,23,42,.75);border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h2{margin:0 0 12px 0;text-align:center;font-weight:700}
  select,input,button{width:100%;padding:12px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:#e5e7eb;box-sizing:border-box}
  input::placeholder{color:rgba(226,232,240,.55)}
  .row{display:flex;gap:10px}
  button{cursor:pointer;border:none;background:#22c55e;color:#081014;font-weight:700}
  button.secondary{background:rgba(148,163,184,.15);color:#e5e7eb;border:1px solid rgba(148,163,184,.25)}
  .msg{margin-top:12px;text-align:center;min-height:22px}
  .hint{opacity:.8;font-size:12px;text-align:center;margin-top:10px}
</style>

<link rel="stylesheet" href="/assets/bolt.css" />
</head>
<body>
  <div class="card">
    <h2>PayTaksi</h2>

    <select id="role">
      <option value="passenger">Müştəri</option>
      <option value="driver">Sürücü</option>
    </select>

    <div class="row" style="margin-top:10px">
      <input id="phone_prefix" value="+994" disabled style="max-width:110px;opacity:.95" />
      <input id="phone_tail" placeholder="0XXXXXXXX" inputmode="numeric" autocomplete="tel" maxlength="9" />
    </div>
    <input id="password" type="password" placeholder="Şifrə" autocomplete="current-password" />
    <input id="name" placeholder="Ad Soyad (qeydiyyat üçün)" autocomplete="name" />

    <div id="driverFields" style="display:none;margin-top:8px">
      <div class="row">
        <input id="car_make" placeholder="Avtomobil markası (məs: Toyota)" />
        <input id="car_model" placeholder="Model (məs: Prius)" />
      </div>
      <div class="row" style="margin-top:6px">
        <input id="car_plate" placeholder="Nömrə (məs: 10-AB-123)" />
        <select id="car_color">
          <option value="ağ">Rəng: ağ</option>
          <option value="qara">Rəng: qara</option>
          <option value="sarı">Rəng: sarı</option>
          <option value="qırmızı">Rəng: qırmızı</option>
          <option value="göy">Rəng: göy</option>
          <option value="yaşıl">Rəng: yaşıl</option>
          <option value="boz">Rəng: boz</option>
        </select>
      </div>
      <input id="car_year" type="number" min="2007" step="1" placeholder="İstehsal ili (2007+)" style="margin-top:6px" />
    </div>

    <div class="row" style="margin-top:6px">
      <button onclick="registerUser()">Qeydiyyat</button>
      <button class="secondary" onclick="loginUser()">Daxil ol</button>
    </div>

    <div class="msg" id="msg"></div>
    <div class="hint">Sürücü hesabı üçün admin təsdiqi lazımdır.</div>
  </div>

<script>
function setMsg(t){ msg.textContent = t || ''; }

function buildPhone(){
  const tail = String(phone_tail.value || '').replace(/\D/g,'').slice(0, 9);
  phone_tail.value = tail;
  return '+994' + tail;
}

function toggleDriverFields(){
  const isD = (role.value === 'driver');
  document.getElementById('driverFields').style.display = isD ? 'block' : 'none';
}

role.addEventListener('change', toggleDriverFields);
toggleDriverFields();

phone_tail.addEventListener('input', ()=>{ phone_tail.value = String(phone_tail.value||'').replace(/\D/g,'').slice(0,9); });

function saveSession(s){
  localStorage.setItem('pt_session', JSON.stringify(s));
}
function getSession(){
  try{ return JSON.parse(localStorage.getItem('pt_session')||'null'); }catch(e){ return null; }
}
function clearSession(){ localStorage.removeItem('pt_session'); }

async function registerUser(){
  setMsg('...');
  const phone = buildPhone();
  const payload = { phone, password: password.value, role: role.value, name: name.value };
  if(role.value === 'driver'){
    payload.car_make = car_make.value;
    payload.car_model = car_model.value;
    payload.car_plate = car_plate.value;
    payload.car_color = car_color.value;
    payload.car_year = car_year.value;
  }
  const res = await fetch('/api/register', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.success){
    if(role.value === 'driver'){
      setMsg('Hörmətli ' + (name.value||'') + ', sürücü qeydiyyatı tamamlandı. Admin təsdiqi gözlənilir.');
    } else {
      setMsg('Hörmətli ' + (name.value||'') + ', siz qeydiyyatdan keçdiniz. İndi "Daxil ol" edin.');
    }
  }else{
    if(data.error === 'PHONE_ROLE_EXISTS') setMsg('Bu telefon bu rol üçün artıq qeydiyyatdan keçib. "Daxil ol" edin.');
    else setMsg(data.error || 'ERROR');
  }
}

async function loginUser(){
  setMsg('...');
  const phone = buildPhone();
  const res = await fetch('/api/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ phone, password: password.value, role: role.value })
  });
  const data = await res.json();
  if(data.pending){
    setMsg('Sürücü hesabı admin təsdiqi gözləyir.');
    return;
  }
  if(data.success){
    const session = { role: role.value, phone, password: password.value, name: data.name || '', is_online: data.is_online || 0 };
    saveSession(session);
    if(role.value === 'driver') location.href = '/app/driver.html';
    else location.href = '/app/passenger.html';
  } else {
    setMsg(data.error || 'ERROR');
  }
}

// If already logged in, go directly
const s = getSession();
if(s && s.role){
  if(s.role === 'driver') location.href = '/app/driver.html';
  else location.href = '/app/passenger.html';
}
</script>
</body>
</html>
