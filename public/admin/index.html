<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi Admin</title>
  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .card{background:rgba(15,23,42,.75);border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:#e5e7eb}
    button{cursor:pointer;border:none;background:#22c55e;color:#081014;font-weight:700}
    button.secondary{background:rgba(148,163,184,.15);color:#e5e7eb;border:1px solid rgba(148,163,184,.25)}
    button.danger{background:#ef4444;color:#fff}
    .msg{margin-top:10px;min-height:22px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.15);text-align:left;font-size:14px}
    th{opacity:.85}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(148,163,184,.25)}
    .pending{background:rgba(234,179,8,.15)}
    .approved{background:rgba(34,197,94,.15)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>PayTaksi Admin</h1>
        <div class="row">
          <button class="secondary" onclick="loadDrivers('pending')">Pending</button>
          <button class="secondary" onclick="loadDrivers('approved')">Approved</button>
          <button class="secondary" onclick="loadDrivers('all')">All</button>
          <button class="danger" onclick="logout()">Çıxış</button>
        </div>
      </div>

      <div id="loginBox" class="card" style="margin-top:14px;background:rgba(2,6,23,.35)">
        <h3 style="margin:0 0 10px 0">Admin giriş</h3>
        <div class="row">
          <input id="u" placeholder="username" />
          <input id="p" placeholder="password" type="password" />
          <button onclick="login()">Daxil ol</button>
        </div>
        <div class="msg" id="loginMsg"></div>
      </div>

      <div id="panelBox" class="hidden" style="margin-top:14px">
        <div class="row">
          <input id="quickPhone" placeholder="Telefon ilə təsdiqlə (+994...)" style="flex:1" />
          <button onclick="approveByPhone()">Approve</button>
        </div>
        <div class="msg" id="msg"></div>

        <hr style="border:none;border-top:1px solid rgba(148,163,184,.18);margin:14px 0" />
        <h3 style="margin:0 0 10px 0">Sistem Ayarları</h3>
        <div class="row" style="align-items:center">
          <label style="opacity:.85">Default driver radius:</label>
          <select id="defRadius">
            <option value="2">2 km</option>
            <option value="4">4 km</option>
            <option value="8">8 km</option>
          </select>

          <label style="opacity:.85">Base (AZN):</label>
          <input id="fareBase" type="number" step="0.01" style="max-width:140px" />
          <label style="opacity:.85">KM (AZN):</label>
          <input id="farePerKm" type="number" step="0.01" style="max-width:140px" />
          <label style="opacity:.85">Dəqiqə (AZN):</label>
          <input id="farePerMin" type="number" step="0.01" style="max-width:140px" />
          <label style="opacity:.85">Min (AZN):</label>
          <input id="fareMin" type="number" step="0.01" style="max-width:140px" />
          <label style="opacity:.85">Komissiya (%):</labe<script>
async function api(url, body){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: body ? JSON.stringify(body) : '{}'
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw data;
  return data;
}
function setText(id, t){ document.getElementById(id).textContent = t || ''; }

async function login(){
  setText('loginMsg','...');
  try{
    await api('/api/admin/login', { username: u.value, password: p.value });
    setText('loginMsg','OK');
    loginBox.classList.add('hidden');
    panelBox.classList.remove('hidden');
    loadDrivers('pending');
    loadSettings();
  }catch(e){
    setText('loginMsg', (e && e.error) ? e.error : 'LOGIN_ERROR');
  }
}
async function logout(){
  try{ await api('/api/admin/logout', {}); }catch(e){}
  panelBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
  setText('msg','');
  setText('loginMsg','Çıxış edildi.');
}
async function loadDrivers(status){
  setText('msg','...');
  const res = await fetch('/api/admin/drivers?status=' + encodeURIComponent(status || 'all'));
  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    panelBox.classList.add('hidden');
    loginBox.classList.remove('hidden');
    setText('loginMsg', (data && data.error) ? data.error : 'ADMIN_REQUIRED');
    setText('msg','');
    return;
  }
  const list = (data && data.drivers) ? data.drivers : [];
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  for(const d of list){
    const tr = document.createElement('tr');
    const statusText = d.approved ? 'Approved' : 'Pending';
    const badgeClass = d.approved ? 'badge approved' : 'badge pending';
    const onlineText = d.is_online ? 'ONLINE' : 'OFFLINE';
    tr.innerHTML = `
      <td>${d.id}</td>
      <td>${(d.name||'')}</td>
      <td>${d.phone}</td>
      <td><span class="${badgeClass}">${statusText}</span></td>
      <td>${onlineText}</td>
      <td>
        ${d.approved ? '' : `<button onclick="approve(${d.id})">Approve</button>`}
        <button class="danger" onclick="delDriver(${d.id})">Sil</button>
      </td>
    `;
    tb.appendChild(tr);
  }
  setText('msg', 'Drivers: ' + list.length);
}
async function approve(id){
  setText('msg','...');
  try{
    const r = await api('/api/admin/approve', { id });
    setText('msg','Approved: ' + (r.changes||0));
    loadDrivers('pending');
    loadSettings();
  }catch(e){
    setText('msg', (e && e.error) ? e.error : 'ERROR');
  }
}
async function approveByPhone(){
  const phone = quickPhone.value.trim();
  if(!phone){ setText('msg','Telefon yaz'); return; }
  setText('msg','...');
  try{
    const r = await api('/api/admin/approve', { phone });
    setText('msg','Approved: ' + (r.changes||0));
    loadDrivers('pending');
    loadSettings();
  }catch(e){
    setText('msg', (e && e.error) ? e.error : 'ERROR');
  }
}
async function delDriver(id){
  if(!confirm('Sürücü silinsin?')) return;
  setText('msg','...');
  try{
    const r = await api('/api/admin/delete-driver', { id });
    setText('msg','Deleted: ' + (r.changes||0));
    loadDrivers('all');
  }catch(e){
    setText('msg', (e && e.error) ? e.error : 'ERROR');
  }
}

async function loadSettings(){
  try{
    const res = await fetch('/api/admin/settings');
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw data;
    const s = data.settings || {};
    const r = Number(s.default_radius_km ?? 4);
    defRadius.value = String([2,4,8].includes(r)?r:4);

    // Pricing
    fareBase.value = Number(s.fare_base ?? 1.0);
    farePerKm.value = Number(s.fare_per_km ?? 0.6);
    farePerMin.value = Number(s.fare_per_min ?? 0.15);
    fareMin.value = Number(s.fare_min ?? 2.0);

    // Commission shown as percent
    const cr = Number(s.commission_rate ?? 0.10);
    commissionRate.value = (cr*100).toFixed(1);
  }catch(e){}
}

}
async function saveSettings(){
  setText('statMsg','...');
  try{
    const payload = {
      default_radius_km: Number(defRadius.value),
      fare_base: Number(fareBase.value),
      fare_per_km: Number(farePerKm.value),
      fare_per_min: Number(farePerMin.value),
      fare_min: Number(fareMin.value),
      commission_rate: Number(commissionRate.value) / 100
    };
    await api('/api/admin/settings', payload);
    setText('statMsg','Yadda saxlandı.');
  }catch(e){
    setText('statMsg', (e && e.error) ? e.error : 'ERROR');
  }
}

}
async function loadStats(){
  setText('statMsg','...');
  try{
    const res = await fetch('/api/admin/stats');
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw data;
    const s = data.stats || {};
    statsBox.innerHTML = `<div class="row" style="margin-top:6px">
      <span class="badge">Rides: ${s.rides||0}</span>
      <span class="badge">Dövriyyə: ${Number(s.total_turnover||0).toFixed(2)} AZN</span>
      <span class="badge">Komissiya: ${Number(s.total_commission||0).toFixed(2)} AZN</span>
    </div>`;
    setText('statMsg','');
  }catch(e){
    setText('statMsg', (e && e.error) ? e.error : 'ERROR');
  }
}

</script>
</body>
</html>
