<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PayTaksi • Tariflər</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:520px;margin:0 auto;padding:22px}
  .card{background:rgba(15,23,42,.75);border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h2{margin:0 0 10px 0}
  label{display:block;margin-top:10px;opacity:.9;font-size:14px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:#e5e7eb}
  select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:#e5e7eb}
  .row{display:flex;gap:10px;margin-top:14px}
  button{flex:1;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  button.save{background:#22c55e;color:#081014}
  button.back{background:rgba(148,163,184,.15);color:#e5e7eb;border:1px solid rgba(148,163,184,.25)}
  .msg{margin-top:10px;min-height:20px;opacity:.9}
  .hint{font-size:12px;opacity:.75;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Tarif Paketləri</h2>

      <label>Paket seç</label>
      <select id="pkg"></select>
      <div class="hint">Bu paketə görə həm “təxmini”, həm də sifariş qiyməti serverdə hesablanır.</div>

      <label>Start qiyməti (AZN)</label>
      <input id="fare_base" type="number" step="0.01" min="0">

      <label>1 km qiyməti (AZN)</label>
      <input id="fare_per_km" type="number" step="0.01" min="0">

      <label>1 dəqiqə qiyməti (AZN)</label>
      <input id="fare_per_min" type="number" step="0.01" min="0">

      <label>Minimum qiymət (AZN)</label>
      <input id="fare_min" type="number" step="0.01" min="0">

      <label>Komissiya (%)</label>
      <input id="commission" type="number" step="1" min="0" max="100">

      <div class="row">
        <button class="back" onclick="location.href='/admin/index.html'">← Geri</button>
        <button class="save" onclick="save()">Yadda saxla</button>
      </div>

      <div class="msg" id="msg"></div>
    </div>
  </div>

<script>
async function load(){
  msg.textContent = '';
  try{
    const r = await fetch('/api/fare-packages');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const d = await r.json();

    const list = (d && d.packages) ? d.packages : [];
    if(!list.length) throw new Error('PACKAGES_EMPTY');

    // build select
    pkg.innerHTML = list.map(p => `<option value="${p.id}">${p.name || p.id}</option>`).join('');
    // default: economy
    const def = list.find(p => p.id==='economy') || list[0];
    pkg.value = def.id;
    window.__pkgs = list;
    fillFrom(def);
  }catch(e){
    msg.textContent = 'Yükləmə xətası: ' + (e && e.message ? e.message : e);
  }
}

function fillFrom(p){
  fare_base.value = (p.fare_base ?? 1).toString();
  fare_per_km.value = (p.fare_per_km ?? 0.6).toString();
  fare_per_min.value = (p.fare_per_min ?? 0.15).toString();
  fare_min.value = (p.fare_min ?? 2).toString();
  commission.value = (p.commission ?? Math.round((p.commission_rate ?? 0.10) * 100)).toString();
}

pkg.addEventListener('change', ()=>{
  const list = window.__pkgs || [];
  const p = list.find(x => x.id === pkg.value);
  if(p) fillFrom(p);
});

async function save(){
  msg.textContent = '';
  const id = pkg.value;
  const data = {
    id,
    fare_base: parseFloat(fare_base.value),
    fare_per_km: parseFloat(fare_per_km.value),
    fare_per_min: parseFloat(fare_per_min.value),
    fare_min: parseFloat(fare_min.value),
    commission: parseInt(commission.value, 10)
  };

  try{
    const r = await fetch('/api/fare-packages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok){
      const t = await r.text();
      throw new Error('HTTP '+r.status+' '+t);
    }
    msg.textContent="Yadda saxlanıldı ✅";

    // refresh list
    await load();
    pkg.value = id;
  }catch(e){
    msg.textContent = 'Yadda saxlanılmadı: ' + (e && e.message ? e.message : e);
  }
}

load();
</script>
</body>
</html>
