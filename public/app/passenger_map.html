<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayTaksi â€¢ XÉ™ritÉ™</title>
  <link rel="stylesheet" href="/assets/bolt.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Bolt-like layout (UI-only) */
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{position:fixed;inset:0;z-index:1}
    .topbar{position:fixed;left:12px;right:12px;top:12px;z-index:5;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.65);backdrop-filter:blur(8px);font-size:12px}
    .pill strong{font-weight:800}
    .btnSmall{padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.65);color:#e5e7eb;cursor:pointer}
    .driverCard{position:fixed;left:12px;right:12px;top:58px;z-index:5;display:none}
    .card{border:1px solid rgba(148,163,184,.22);background:rgba(15,23,42,.78);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.35)}
    .cardInner{padding:12px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .driverMeta{display:flex;flex-direction:column;gap:2px}
    .driverMeta .t{font-weight:900}
    .driverMeta .s{opacity:.8;font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);background:rgba(2,6,23,.45);font-size:12px}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:6}
    .sheet .handle{width:44px;height:5px;border-radius:999px;background:rgba(148,163,184,.35);margin:10px auto 0 auto}
    .sheet .panel{margin:10px 12px 12px 12px}
    .sheet .panel .content{padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:12px;opacity:.8}
    input{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:#e5e7eb;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .primary{width:100%;padding:14px 14px;border-radius:16px;border:none;background:#22c55e;color:#081014;font-weight:900;cursor:pointer}
    .secondary{padding:12px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:rgba(148,163,184,.14);color:#e5e7eb;cursor:pointer}
    .priceRow{display:flex;gap:10px;flex-wrap:wrap}
    .priceRow .chip{flex:1;justify-content:center}
    .toast{position:fixed;left:50%;bottom:120px;transform:translateX(-50%);z-index:9;display:none;max-width:min(92vw,720px)}
    .toast .cardInner{justify-content:center}
    /* Suggestions */
    .suggest{position:relative}
    .suggestList{position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:10;display:none;overflow:hidden}
    .suggestList button{width:100%;text-align:left;padding:10px 12px;border:none;background:rgba(2,6,23,.92);color:#e5e7eb;border-bottom:1px solid rgba(148,163,184,.14);cursor:pointer}
    .suggestList button:hover{background:rgba(148,163,184,.12)}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="pill" id="statusPill"><strong>Status:</strong> HazÄ±r</div>
    <button class="btnSmall" onclick="logout()">Ã‡Ä±xÄ±ÅŸ</button>
  </div>

  <div class="driverCard" id="driverCard">
    <div class="card">
      <div class="cardInner">
        <div class="driverMeta">
          <div class="t" id="driverTitle">SÃ¼rÃ¼cÃ¼</div>
          <div class="s" id="driverSub">â€”</div>
        </div>
        <div class="row">
          <span class="chip" id="etaChip">ETA: â€”</span>
          <button class="secondary" onclick="focusDriver()">Fokus</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="card"><div class="cardInner" id="toastText">â€”</div></div>
  </div>

  <div class="sheet">
    <div class="handle"></div>
    <div class="panel card">
      <div class="content">
        <div class="grid">
          <div class="suggest">
            <label>Haradan</label>
            <input id="from" placeholder="Cari yer..." autocomplete="off">
            <div class="card suggestList" id="fromSug"></div>
          </div>

          <div class="suggest">
            <label>Haraya</label>
            <input id="to" placeholder="Ãœnvan yaz..." autocomplete="off">
            <div class="card suggestList" id="toSug"></div>
          </div>

          <div class="priceRow">
            <span class="chip" id="kmChip">TÉ™xmini: â€” km</span>
            <span class="chip" id="fareChip">TÉ™xmini: â€” AZN</span>
          </div>

          <button class="primary" onclick="createOrder()">ðŸš• SifariÅŸ et</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* NOTE: UI-only overlay. It keeps existing API calls minimal.
   If your existing passenger_map.html had more logic, keep that version and merge only UI.
*/
function getSession(){ try{return JSON.parse(localStorage.getItem('pt_session')||'null');}catch(e){return null;} }
const s = getSession();
if(!s || s.role!=='passenger'){ location.href='/'; }

function logout(){ localStorage.removeItem('pt_session'); location.href='/'; }
function showToast(t){
  const el=document.getElementById('toast'); document.getElementById('toastText').textContent=t;
  el.style.display='block'; clearTimeout(window.__tt); window.__tt=setTimeout(()=>el.style.display='none',2200);
}
function setStatus(t){ document.getElementById('statusPill').innerHTML='<strong>Status:</strong> '+t; }

let map = L.map('map', { zoomControl:false }).setView([40.4093,49.8671], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
L.control.zoom({position:'bottomright'}).addTo(map);

let pickup=null, dropoff=null;
let fromMarker=null, toMarker=null;
let driverMarker=null;
let lastDriver=null;

const NOM='https://nominatim.openstreetmap.org';
const OSRM='https://router.project-osrm.org';

async function j(url){ const r=await fetch(url); return await r.json(); }

async function search(q){
  const url=`${NOM}/search?format=jsonv2&addressdetails=1&limit=6&countrycodes=az&q=${encodeURIComponent(q)}&accept-language=az`;
  const arr=await j(url);
  return (arr||[]).map(x=>({text:x.display_name,lat:+x.lat,lon:+x.lon})).filter(x=>isFinite(x.lat)&&isFinite(x.lon));
}
function renderSug(el, items, pick){
  el.innerHTML='';
  for(const it of items){
    const b=document.createElement('button');
    b.type='button';
    b.textContent=it.text;
    b.onclick=()=>pick(it);
    el.appendChild(b);
  }
  el.style.display = items.length ? 'block' : 'none';
}
function hook(inp, sugEl, setter){
  let t=null;
  inp.addEventListener('input', ()=>{
    const q=inp.value.trim();
    if(t) clearTimeout(t);
    if(q.length<3){ sugEl.style.display='none'; return; }
    t=setTimeout(async ()=>{
      try{
        const items=await search(q);
        renderSug(sugEl, items, (it)=>{ setter(it); sugEl.style.display='none'; });
      }catch(e){ sugEl.style.display='none'; }
    }, 500);
  });
}
function havKm(a,b,c,d){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a), dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function updateEstimate(){
  const kmEl=document.getElementById('kmChip'), fEl=document.getElementById('fareChip');
  if(!pickup||!dropoff){ kmEl.textContent='TÉ™xmini: â€” km'; fEl.textContent='TÉ™xmini: â€” AZN'; return; }
  const km=havKm(pickup.lat,pickup.lon,dropoff.lat,dropoff.lon);
  const base=1.0, perKm=0.6, min=2.0;
  const fare=Math.max(min, base+perKm*km);
  kmEl.textContent='TÉ™xmini: '+km.toFixed(1)+' km';
  fEl.textContent='TÉ™xmini: '+fare.toFixed(2)+' AZN';
}

hook(document.getElementById('from'), document.getElementById('fromSug'), (it)=>{
  pickup=it;
  if(fromMarker) map.removeLayer(fromMarker);
  fromMarker=L.marker([it.lat,it.lon]).addTo(map).bindPopup('Haradan').openPopup();
  map.setView([it.lat,it.lon], 14);
  updateEstimate();
});
hook(document.getElementById('to'), document.getElementById('toSug'), (it)=>{
  dropoff=it;
  if(toMarker) map.removeLayer(toMarker);
  toMarker=L.marker([it.lat,it.lon]).addTo(map).bindPopup('Haraya').openPopup();
  map.setView([it.lat,it.lon], 14);
  updateEstimate();
});

async function createOrder(){
  if(!pickup||!dropoff){ showToast('ÃœnvanlarÄ± seÃ§in'); return; }
  setStatus('GÃ¶ndÉ™rilir...');
  try{
    const r = await fetch('/api/orders/create', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone:s.phone, password:s.password, pickup, dropoff })
    });
    const d = await r.json();
    if(d.success){
      showToast('SifariÅŸ yaradÄ±ldÄ± #' + d.order_id);
      setStatus('SÃ¼rÃ¼cÃ¼ gÃ¶zlÉ™nilir');
    }else{
      showToast(d.error||'XÉ™ta');
      setStatus('HazÄ±r');
    }
  }catch(e){
    showToast('ÅžÉ™bÉ™kÉ™ xÉ™tasÄ±');
    setStatus('HazÄ±r');
  }
}

function focusDriver(){
  if(lastDriver) map.setView([lastDriver.lat,lastDriver.lon], 15);
}
</script>
</body>
</html>
