<!doctype html>
<html lang="az">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PayTaksi â€” SÃ¼rÃ¼cÃ¼ Paneli</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      :root{
        --bg:#0f172a;
        --panel:#111827;
        --card:#0b1220;
        --text:#e5e7eb;
        --muted:#94a3b8;
        --green:#22c55e;
        --red:#ef4444;
        --amber:#f59e0b;
        --border:rgba(255,255,255,.10);
      }
      body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
      .topbar{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;}
      .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.07);color:var(--muted)}
      .badge.ok{background:rgba(34,197,94,.15);color:#bbf7d0}
      .badge.warn{background:rgba(245,158,11,.15);color:#fde68a}
      .badge.err{background:rgba(239,68,68,.15);color:#fecaca}

      #map{height:52vh;}
      .sheet{position:relative;margin-top:-18px;border-top-left-radius:18px;border-top-right-radius:18px;background:var(--panel);border-top:1px solid var(--border);padding:12px 12px 18px;}
      .sheet-handle{width:64px;height:5px;border-radius:999px;background:rgba(255,255,255,.15);margin:0 auto 10px;}
      .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
      .btn{border:0;border-radius:14px;padding:12px 14px;font-weight:700;color:#06121f;cursor:pointer;flex:1;min-width:140px;}
      .btn.green{background:var(--green);} .btn.red{background:var(--red);color:#fff;} .btn.gray{background:#334155;color:#fff;}
      .btn.small{padding:10px 12px;border-radius:12px;font-weight:700;}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;margin-top:10px;}
      .title{font-size:16px;font-weight:800;}
      .muted{color:var(--muted);font-size:13px;}
      .kv{display:flex;justify-content:space-between;gap:10px;margin-top:6px;color:var(--muted);font-size:13px;}
      .kv b{color:var(--text);font-weight:700;}
      .hr{height:1px;background:var(--border);margin:10px 0;}
      .input{width:100%;box-sizing:border-box;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;outline:none;}
      .chatlog{max-height:160px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px;}
      .bubble{max-width:90%;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.07);}
      .bubble.me{align-self:flex-end;background:rgba(34,197,94,.18);}
      .footer-note{margin-top:10px;color:var(--muted);font-size:12px;}
    </style>
  </head>

  <body>
    <div class="topbar">
      <div class="title">ğŸš• SÃ¼rÃ¼cÃ¼ Paneli</div>
      <div id="statusBadge" class="badge warn">BaÄŸlanÄ±râ€¦</div>
    </div>

    <div id="map"></div>

    <div class="sheet">
      <div class="sheet-handle"></div>

      <div class="row">
        <button id="btnOnline" class="btn green">ğŸŸ¢ Onlayn ol</button>
        <button id="btnOffline" class="btn red">ğŸ”´ Oflayn ol</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSendLoc" class="btn gray">ğŸ“ Yer gÃ¶ndÉ™r</button>
        <button id="btnRefresh" class="btn gray">ğŸ”„ YenilÉ™</button>
      </div>

      <div id="orderCard" class="card" style="display:none">
        <div class="title">ğŸ“¥ Yeni sifariÅŸ</div>
        <div id="orderMeta" class="muted" style="margin-top:4px"></div>
        <div class="hr"></div>
        <div class="row">
          <button id="btnAccept" class="btn green small">âœ… QÉ™bul et</button>
          <button id="btnArrived" class="btn gray small">ğŸ“ Ã‡atdÄ±m</button>
          <button id="btnFinish" class="btn red small">ğŸ Bitdi</button>
        </div>

        <div class="hr"></div>
        <div class="title" style="font-size:14px">ğŸ’¬ Chat</div>
        <div id="chatLog" class="chatlog"></div>
        <div class="row" style="margin-top:8px">
          <input id="chatText" class="input" placeholder="Mesaj yazâ€¦" />
          <button id="btnChatSend" class="btn green small" style="flex:0 0 auto;min-width:auto">GÃ¶ndÉ™r</button>
        </div>
      </div>

      <div class="card">
        <div class="title" style="font-size:14px">â„¹ï¸ MÉ™lumat</div>
        <div class="kv"><span>Driver ID</span><b id="driverId">-</b></div>
        <div class="kv"><span>API</span><b id="apiBase">-</b></div>
        <div class="footer-note">Qeyd: Yer avtomatik yenilÉ™nir. Problem olsa, â€œYer gÃ¶ndÉ™râ€ vÉ™ â€œYenilÉ™â€ dÃ¼ymÉ™lÉ™rini istifadÉ™ et.</div>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      const api = location.origin; // Render URL
      const userId = tg?.initDataUnsafe?.user?.id || null;
      document.getElementById('driverId').textContent = userId || 'unknown';
      document.getElementById('apiBase').textContent = api;

      const badge = document.getElementById('statusBadge');
      function setBadge(kind, text){
        badge.className = 'badge ' + kind;
        badge.textContent = text;
      }

      // Map
      const map = L.map('map', { zoomControl:true }).setView([40.4093, 49.8671], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const meMarker = L.marker([40.4093, 49.8671]).addTo(map).bindPopup('SÉ™n');
      let lastPos = null;

      async function postJson(url, body){
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body||{})
        });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      }

      async function setOnline(online){
        if(!userId) return alert('Telegram user ID tapÄ±lmadÄ±.');
        await postJson(api + '/api/driver/update', {
          driverId: String(userId),
          name: tg?.initDataUnsafe?.user?.first_name || 'Driver',
          car: 'Car',
          lat: lastPos?.lat,
          lon: lastPos?.lon,
          online: !!online,
        });
        setBadge(online ? 'ok' : 'warn', online ? 'Onlayn' : 'Oflayn');
      }

      async function sendLocationNow(){
        if(!navigator.geolocation) return alert('Geolocation dÉ™stÉ™klÉ™nmir.');
        return new Promise((resolve, reject)=>{
          navigator.geolocation.getCurrentPosition(async (pos)=>{
            try{
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              lastPos = {lat, lon};
              meMarker.setLatLng([lat, lon]);
              map.setView([lat, lon], 15);
              if(userId){
                await postJson(api + '/api/driver/update', {
                  driverId: String(userId),
                  name: tg?.initDataUnsafe?.user?.first_name || 'Driver',
                  car: 'Car',
                  lat, lon,
                  online: true,
                });
              }
              setBadge('ok','Yer yenilÉ™ndi');
              resolve();
            }catch(e){
              setBadge('err','XÉ™ta');
              reject(e);
            }
          }, (err)=>{
            setBadge('err','Yer icazÉ™si yoxdur');
            reject(err);
          }, { enableHighAccuracy:true, timeout:10000 });
        });
      }

      // auto watch
      if(navigator.geolocation){
        navigator.geolocation.watchPosition(async (pos)=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          lastPos = {lat, lon};
          meMarker.setLatLng([lat, lon]);
          if(userId){
            try{
              await postJson(api + '/api/driver/update', {
                driverId: String(userId),
                name: tg?.initDataUnsafe?.user?.first_name || 'Driver',
                car: 'Car',
                lat, lon,
                online: true,
              });
              setBadge('ok','Onlayn');
            }catch(_){
              // ignore
            }
          }
        }, ()=>{}, { enableHighAccuracy:true, maximumAge:5000 });
      }

      // Orders
      let activeOrder = null;
      const orderCard = document.getElementById('orderCard');
      const orderMeta = document.getElementById('orderMeta');
      const chatLog = document.getElementById('chatLog');
      const chatText = document.getElementById('chatText');

      function showOrder(o){
        activeOrder = o;
        orderCard.style.display = 'block';
        orderMeta.textContent = `ID: ${o.id} â€¢ ${o.fromText || ''} â†’ ${o.toText || ''} â€¢ ${o.distanceKm || ''} km â€¢ ${o.priceAzN || ''} AZN`;
        chatLog.innerHTML = '';
        (o.chat||[]).forEach(m=>appendChat(m.from, m.text));
      }

      function hideOrder(){
        activeOrder = null;
        orderCard.style.display = 'none';
      }

      function appendChat(from, text){
        const div = document.createElement('div');
        div.className = 'bubble' + (String(from) === String(userId) ? ' me' : '');
        div.textContent = text;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function poll(){
        try{
          // if we already accepted an order, refresh its state by polling pending too (simple)
          const data = await fetch(api + '/api/order/pending').then(r=>r.ok?r.json():null);
          if(data && data.order){
            // show the newest pending only if no active order accepted by me
            if(!activeOrder || activeOrder.status === 'pending'){
              showOrder(data.order);
            }
          }
        }catch(e){
          // ignore
        }
      }

      setInterval(poll, 2500);
      poll();

      document.getElementById('btnAccept').onclick = async ()=>{
        if(!activeOrder) return;
        try{
          const res = await postJson(api + `/api/order/${activeOrder.id}/accept`, { driverId: String(userId) });
          showOrder(res.order);
          setBadge('ok','QÉ™bul edildi');
        }catch(e){
          alert('QÉ™bul olunmadÄ±: ' + e.message);
        }
      };
      document.getElementById('btnArrived').onclick = async ()=>{
        if(!activeOrder) return;
        try{
          const res = await postJson(api + `/api/order/${activeOrder.id}/status`, { status: 'arrived' });
          showOrder(res.order);
          setBadge('ok','Ã‡atdÄ±n');
        }catch(e){
          alert('XÉ™ta: ' + e.message);
        }
      };
      document.getElementById('btnFinish').onclick = async ()=>{
        if(!activeOrder) return;
        try{
          const res = await postJson(api + `/api/order/${activeOrder.id}/status`, { status: 'finished' });
          showOrder(res.order);
          setBadge('ok','Bitdi');
        }catch(e){
          alert('XÉ™ta: ' + e.message);
        }
      };

      document.getElementById('btnChatSend').onclick = async ()=>{
        if(!activeOrder) return;
        const text = chatText.value.trim();
        if(!text) return;
        chatText.value = '';
        try{
          const res = await postJson(api + `/api/order/${activeOrder.id}/chat`, { from: String(userId), text });
          // backend returns full order with chat
          showOrder(res.order);
        }catch(e){
          appendChat(String(userId), text);
        }
      };

      document.getElementById('btnOnline').onclick = async ()=>{
        try{ await setOnline(true); }catch(e){ alert('XÉ™ta: '+e.message); }
      };
      document.getElementById('btnOffline').onclick = async ()=>{
        try{ await setOnline(false); }catch(e){ alert('XÉ™ta: '+e.message); }
      };
      document.getElementById('btnSendLoc').onclick = async ()=>{
        try{ await sendLocationNow(); }catch(e){ alert('Yer gÃ¶ndÉ™rilmÉ™di.'); }
      };
      document.getElementById('btnRefresh').onclick = ()=>{
        poll();
      };

      setBadge('warn','HazÄ±r');
    </script>
  </body>
</html>
