<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Driver</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="/web/style.css"/></head>
<body>
<div class="topbar"><div class="wrap"><div class="brand"><div class="logo"></div><div><div style="font-weight:900">PayTaksi</div><div class="sub">S√ºr√ºc√º ‚Ä¢ Uber/Bolt</div></div></div><div class="badge off" id="state">OFFLINE</div></div></div>
<div id="map" class="map"></div>
<div class="sheet card"><div class="col">
<div class="row" style="justify-content:space-between"><div class="h">S√ºr√ºc√º</div><div class="small" id="uidBox">ID: ‚Äî</div></div>
<div class="row"><button class="btn btn-green" id="goOnline" style="flex:1">üü¢ Online</button><button class="btn btn-danger" id="goOffline" style="flex:1">üî¥ Offline</button></div>
<div class="item"><div class="t">Sifari≈ül…ôr</div><div class="d">Yeni sifari≈ül…ôr live d√º≈ü√ºr.</div></div>
<div id="orders" class="list"></div>
</div></div>
<script>
const uid=new URLSearchParams(location.search).get("uid")||"";uidBox.textContent="ID: "+(uid||"‚Äî");
const BACKEND=location.origin;let online=false;
function setState(){state.textContent=online?"ONLINE":"OFFLINE";state.className="badge"+(online?"":" off");}
goOnline.onclick=()=>{online=true;setState();};goOffline.onclick=()=>{online=false;setState();};setState();

const map=L.map("map",{zoomControl:false}).setView([40.4093,49.8671],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let marker=null;function setMarker(lat,lon){if(!marker){marker=L.circleMarker([lat,lon],{radius:8}).addTo(map);}else marker.setLatLng([lat,lon]);}

navigator.geolocation.watchPosition(async p=>{
  const lat=p.coords.latitude, lon=p.coords.longitude;
  map.setView([lat,lon],16); setMarker(lat,lon);
  if(online && uid){
    await fetch(`${BACKEND}/api/driver/update`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({driverId:uid,lat,lon,online})}).catch(()=>{});
  }
},()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});

const orderMap=new Map();
function draw(){
  const list=[...orderMap.values()].filter(o=>o.status==="SEARCHING"||o.driverId===uid).sort((a,b)=>b.createdAt-a.createdAt).slice(0,8);
  orders.innerHTML="";
  list.forEach(o=>{
    const mine=o.driverId===uid;
    const div=document.createElement("div");div.className="item";
    div.innerHTML=`<div class="t">#${o.orderId} ‚Ä¢ ${o.price} AZN ${mine?"‚Ä¢ S∆èN":""}</div>
    <div class="d">${o.pickup.display||""}<br/>‚Üí ${o.dropoff.display||""}<br/>Status: <b>${o.status}</b></div>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-green" style="flex:1" ${o.status!=="SEARCHING"||mine?"disabled":""}>Q…ôbul</button>
      <button class="btn btn-ghost" style="flex:1" ${!mine?"disabled":""}>√áatdƒ±m</button>
      <button class="btn btn-ghost" style="flex:1" ${!mine?"disabled":""}>Ba≈üla</button>
      <button class="btn btn-danger" style="flex:1" ${!mine?"disabled":""}>Bitdi</button>
    </div>`;
    const b=div.querySelectorAll("button");
    b[0].onclick=async()=>{await fetch(`${BACKEND}/api/order/${o.orderId}/accept`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({driverId:uid})}).catch(()=>{});};
    b[1].onclick=async()=>{await fetch(`${BACKEND}/api/order/${o.orderId}/status`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({status:"ARRIVED"})}).catch(()=>{});};
    b[2].onclick=async()=>{await fetch(`${BACKEND}/api/order/${o.orderId}/status`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({status:"IN_TRIP"})}).catch(()=>{});};
    b[3].onclick=async()=>{await fetch(`${BACKEND}/api/order/${o.orderId}/status`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({status:"DONE"})}).catch(()=>{});};
    orders.appendChild(div);
  });
}

let ws;
function connectWS(){
  const proto=location.protocol==="https:"?"wss":"ws";
  ws=new WebSocket(`${proto}://${location.host}`);
  ws.onclose=()=>setTimeout(connectWS,1500);
  ws.onmessage=(ev)=>{
    try{
      const msg=JSON.parse(ev.data);
      if(msg.type==="orders_snapshot"){orderMap.clear();msg.orders.forEach(o=>orderMap.set(o.orderId,o));draw();}
      if(msg.type==="order_created"){orderMap.set(msg.order.orderId,msg.order);draw();}
      if(msg.type==="order_accepted"){orderMap.set(msg.order.orderId,msg.order);draw();}
      if(msg.type==="order_status"){const o=orderMap.get(msg.orderId);if(o){o.status=msg.status;draw();}}
    }catch(e){}
  };
}
connectWS();
</script>
<div class="modal" id="regModal">
  <div class="modalBox">
    <div style="font-weight:900;font-size:18px">S√ºr√ºc√º Qeydiyyatƒ±</div>
    <div class="small" style="margin-top:6px">T…ôsdiq olmadan online ola bilm…ôzs…ôn.</div>

    <div class="field"><div class="label">Ad Soyad</div><input id="rFull" class="input" placeholder="Ad Soyad"></div>
    <div class="field"><div class="label">Telefon</div><input id="rPhone" class="input" placeholder="+994..."></div>
    <div class="field"><div class="label">Avtomobil modeli</div><input id="rModel" class="input" placeholder="Toyota Prius..."></div>
    <div class="field"><div class="label">N√∂mr…ô</div><input id="rPlate" class="input" placeholder="10-AA-123"></div>
    <div class="field"><div class="label">R…ông</div><input id="rColor" class="input" placeholder="Aƒü"></div>
    <div class="field"><div class="label">V…ôsiq…ô n√∂mr…ôsi</div><input id="rLicNo" class="input" placeholder="AZE..."></div>

    <div class="row" style="gap:10px;margin-top:10px">
      <button class="btn" id="btnLic">V…ôsiq…ô ≈ü…ôkli</button>
      <button class="btn" id="btnCar">Avtomobil ≈ü…ôkli</button>
    </div>
    <div class="small" id="uplInfo" style="margin-top:8px"></div>

    <div class="row" style="margin-top:12px;gap:10px">
      <button class="btn btn-green" id="btnSend" style="flex:1">G√∂nd…ôr</button>
      <button class="btn" id="btnClose" style="flex:1">Baƒüla</button>
    </div>
  </div>
</div>

<input type="file" id="filePick" accept="image/*" style="display:none">

<script>
let licUrl="", carUrl="";
async function getSign(folder){
  const r = await fetch(`${BACKEND}/api/upload/sign`, {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({folder})});
  return await r.json();
}
async function uploadToCloudinary(file, folder){
  const sign = await getSign(folder);
  if(!sign.ok) throw new Error(sign.error||"upload_not_configured");
  const fd = new FormData();
  fd.append("file", file);
  fd.append("api_key", sign.apiKey);
  fd.append("timestamp", sign.timestamp);
  fd.append("folder", sign.folder);
  fd.append("signature", sign.signature);
  const url = `https://api.cloudinary.com/v1_1/${sign.cloudName}/image/upload`;
  const resp = await fetch(url, {method:"POST", body: fd});
  const j = await resp.json();
  if(!j.secure_url) throw new Error(j.error?.message || "upload_failed");
  return j.secure_url;
}

function openReg(){ regModal.classList.add('on'); }
function closeReg(){ regModal.classList.remove('on'); }

btnClose.onclick=closeReg;

btnLic.onclick=()=>{ filePick.dataset.kind="lic"; filePick.click(); };
btnCar.onclick=()=>{ filePick.dataset.kind="car"; filePick.click(); };

filePick.onchange=async()=>{
  const f=filePick.files && filePick.files[0];
  if(!f) return;
  uplInfo.textContent="Y√ºkl…ônir...";
  try{
    const u = await uploadToCloudinary(f, "paytaksi/driver_docs");
    if(filePick.dataset.kind==="lic") licUrl=u; else carUrl=u;
    uplInfo.textContent = `‚úÖ Y√ºkl…ôndi: ${(filePick.dataset.kind==="lic"?"V…ôsiq…ô":"Ma≈üƒ±n")}`;
    haptic('light');
  }catch(e){
    uplInfo.textContent = "‚ùå Upload: "+(e.message||"x…ôta");
    toast("Upload x…ôtasƒ±", e.message||"cloudinary", "");
  }finally{
    filePick.value="";
  }
};

btnSend.onclick=async()=>{
  const payload={
    driverId:String(uid||""),
    fullName:rFull.value.trim(),
    phone:rPhone.value.trim(),
    carModel:rModel.value.trim(),
    carPlate:rPlate.value.trim(),
    carColor:rColor.value.trim(),
    licenseNumber:rLicNo.value.trim(),
    licensePhoto: licUrl,
    carPhoto: carUrl
  };
  if(!payload.fullName || !payload.phone || !payload.carModel || !payload.carPlate || !payload.licenseNumber){
    toast("Doldur", "Z…ôruri sah…ôl…ôri doldur", ""); return;
  }
  setBtnLoading(btnSend,true);
  try{
    const r=await fetch(`${BACKEND}/api/driver/register`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(!j.ok){ toast("X…ôta", j.error||""); return; }
    toast("G√∂nd…ôrildi","Admin t…ôsdiqi g√∂zl…ônilir","success");
    haptic('medium');
    closeReg();
  }catch(e){ toast("X…ôta","server"); }
  finally{ setBtnLoading(btnSend,false,"G√∂nd…ôrildi"); }
};

async function checkApproval(){
  try{
    const r=await fetch(`${BACKEND}/api/driver/status/${encodeURIComponent(String(uid||""))}`);
    const j=await r.json();
    if(!j.ok || j.status==="NONE"){
      toast("Qeydiyyat lazƒ±mdƒ±r","S√ºr√ºc√º formunu doldur","");
      openReg();
      return {status:"NONE"};
    }
    if(j.status==="REJECTED"){
      toast("R…ôdd edildi", j.rejectedReason||"Admin r…ôdd etdi", "");
      openReg();
      return j;
    }
    if(j.status!=="APPROVED"){
      toast("G√∂zl…ôm…ôd…ô","Admin t…ôsdiqi g√∂zl…ônilir","");
      return j;
    }
    return j;
  }catch(e){ return {status:"ERR"}; }
}
</script>

</body></html>
