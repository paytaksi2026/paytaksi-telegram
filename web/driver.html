<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayTaksi • Sürücü</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
<header>
  <h1>PayTaksi • Sürücü</h1>
  <span class="badge" id="envBadge">API: <span id="apiBase"></span></span>
</header>

<div class="container">
  <div class="card" id="authBox" style="display:none">
    <h2 style="margin:0 0 10px">Giriş / Qeydiyyat (Sürücü)</h2>
    <div class="row">
      <div class="col">
        <label>Telefon</label>
        <input id="loginPhone" placeholder="+994..." />
        <label>Şifrə</label>
        <input id="loginPass" type="password" placeholder="****" />
        <button class="primary" id="btnLogin">Giriş</button>
      </div>
      <div class="col">
        <label>Ad Soyad</label>
        <input id="regName" placeholder="Ad Soyad" />
        <label>Telefon</label>
        <input id="regPhone" placeholder="+994..." />
        <label>Şifrə</label>
        <input id="regPass" type="password" placeholder="min 4" />
        <label>Avtomobil modeli</label>
        <input id="regCarModel" placeholder="Toyota Prius" />
        <label>Nömrə</label>
        <input id="regCarNumber" placeholder="10-AA-123" />
        <button class="secondary" id="btnRegister">Qeydiyyat</button>
      </div>
    </div>
    <p class="small" id="authStatus"></p>
  </div>

  <div id="userBox" style="display:none">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <span class="badge" id="approveBadge">Yoxlanır...</span>
              <span class="badge offline" id="onlineBadge">OFFLINE</span>
            </div>
            <button class="secondary" id="btnLogout" style="max-width:160px">Çıxış</button>
          </div>
          <hr />

          <div class="row">
            <button class="primary" id="btnGoOnline">Online</button>
            <button class="danger" id="btnGoOffline">Offline</button>
          </div>

          <p class="small" id="driverInfo"></p>

          <hr />
          <h3 style="margin:0 0 10px">Aktiv sifariş</h3>
          <div id="rideCard" class="card" style="background:rgba(2,6,23,.35)">
            <p class="small">Hələ sifariş yoxdur.</p>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div id="map"></div>
          <p class="small" style="margin-top:10px">GPS açıq olmalıdır. Online olanda sistem yaxın sifarişi sürücüyə təyin edir.</p>
        </div>
      </div>
    </div>
  </div>

  <p class="small footerlinks" style="margin-top:14px">
    <a href="passenger.html">Müştəri paneli</a> • <a href="admin.html">Admin panel</a>
  </p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { mountAuth, mapsLink } from './app.js';

  document.getElementById('apiBase').textContent = (localStorage.getItem('API_BASE')||location.origin);
  mountAuth('driver');

  const token=localStorage.getItem('token')||'';
  const API=(localStorage.getItem('API_BASE')||'').trim()||location.origin.replace(/\/$/,'');

  const map = L.map('map').setView([40.4093, 49.8671], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
  let meMarker=null;

  async function api(path, opts={}){
    const r=await fetch(API+path,{...opts,headers:{'Content-Type':'application/json','Authorization':'Bearer '+token,...(opts.headers||{})}});
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d.error||'request_failed');
    return d;
  }

  async function refreshMe(){
    try{
      const me=await api('/api/driver/me',{method:'GET'});
      const approved=me.driver.is_approved;
      document.getElementById('approveBadge').textContent = approved ? 'TƏSDİQLƏNİB' : 'ADMIN TƏSDİQİ GÖZLƏYİR';
      document.getElementById('approveBadge').className = 'badge ' + (approved ? 'online':'offline');
      document.getElementById('onlineBadge').textContent = me.driver.is_online ? 'ONLINE' : 'OFFLINE';
      document.getElementById('onlineBadge').className = 'badge ' + (me.driver.is_online ? 'online':'offline');
      document.getElementById('driverInfo').textContent = `Avto: ${me.driver.car_model||'-'} ${me.driver.car_number||''}`;
    }catch(e){
      document.getElementById('driverInfo').textContent='Xəta: '+e.message;
    }
  }

  async function setOnline(online){
    await api('/api/driver/online',{method:'POST',body:JSON.stringify({online})});
    await refreshMe();
  }

  document.getElementById('btnGoOnline').addEventListener('click',()=>setOnline(true).catch(e=>alert(e.message)));
  document.getElementById('btnGoOffline').addEventListener('click',()=>setOnline(false).catch(e=>alert(e.message)));

  // GPS watch + send location
  let watchId=null;
  function startGPS(){
    if(!navigator.geolocation) return;
    watchId = navigator.geolocation.watchPosition(async (pos)=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      if(meMarker) map.removeLayer(meMarker);
      meMarker=L.marker([lat,lon]).addTo(map).bindPopup('Mən');
      map.setView([lat,lon], 14);
      try{ await api('/api/driver/location',{method:'POST',body:JSON.stringify({lat,lon})}); }catch{}
    }, (err)=>{
      console.log(err);
    }, { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
  }
  startGPS();

  function renderRide(r){
    const box=document.getElementById('rideCard');
    if(!r){ box.innerHTML='<p class="small">Hələ sifariş yoxdur.</p>'; return; }
    const navPickup = mapsLink(r.pickup_lat, r.pickup_lng);
    const navDrop = mapsLink(r.drop_lat, r.drop_lng);
    box.innerHTML = `
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <div><b>Status:</b> ${r.status}</div>
          <div class="small">Müştəri: ${r.passenger_name||''} ${r.passenger_phone||''}</div>
          <div class="small">Qiymət: ${r.price_azn} AZN • Məsafə: ${Number(r.distance_km).toFixed(2)} km</div>
        </div>
      </div>
      <hr />
      <div class="small"><b>Pickup:</b> ${r.pickup_text||''}</div>
      <div class="small"><b>Drop:</b> ${r.drop_text||''}</div>
      <div class="row" style="margin-top:10px">
        <a href="${navPickup}" target="_blank" style="flex:1"><button class="secondary" type="button">Pickup naviqasiya</button></a>
        <a href="${navDrop}" target="_blank" style="flex:1"><button class="secondary" type="button">Drop naviqasiya</button></a>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="btnAccept">Qəbul et</button>
        <button class="secondary" id="btnArrived">Çatdım</button>
        <button class="secondary" id="btnStart">Başlat</button>
        <button class="danger" id="btnFinish">Bitir</button>
      </div>
    `;

    const bind = (id, fn)=>{ const b=document.getElementById(id); if(b) b.onclick=fn; };
    bind('btnAccept', async ()=>{ await api(`/api/driver/rides/${r.id}/accept`,{method:'POST'}); });
    bind('btnArrived', async ()=>{ await api(`/api/driver/rides/${r.id}/arrived`,{method:'POST'}); });
    bind('btnStart', async ()=>{ await api(`/api/driver/rides/${r.id}/start`,{method:'POST'}); });
    bind('btnFinish', async ()=>{ await api(`/api/driver/rides/${r.id}/finish`,{method:'POST'}); });
  }

  async function poll(){
    try{
      const r=await api('/api/driver/rides/assigned',{method:'GET'});
      renderRide(r.ride);
      await refreshMe();
    }catch(e){}
    setTimeout(poll, 3000);
  }

  poll();
</script>
</body>
</html>
