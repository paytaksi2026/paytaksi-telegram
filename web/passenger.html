<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayTaksi • Müştəri</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
<header>
  <h1>PayTaksi • Müştəri</h1>
  <span class="badge" id="envBadge">API: <span id="apiBase"></span></span>
</header>

<div class="container">
  <div class="card" id="authBox" style="display:none">
    <h2 style="margin:0 0 10px">Giriş / Qeydiyyat</h2>
    <div class="row">
      <div class="col">
        <label>Telefon</label>
        <input id="loginPhone" placeholder="+994..." />
        <label>Şifrə</label>
        <input id="loginPass" type="password" placeholder="****" />
        <button class="primary" id="btnLogin">Giriş</button>
      </div>
      <div class="col">
        <label>Ad Soyad</label>
        <input id="regName" placeholder="Ad Soyad" />
        <label>Telefon</label>
        <input id="regPhone" placeholder="+994..." />
        <label>Şifrə</label>
        <input id="regPass" type="password" placeholder="min 4" />
        <button class="secondary" id="btnRegister">Qeydiyyat</button>
      </div>
    </div>
    <p class="small" id="authStatus"></p>
  </div>

  <div id="userBox" style="display:none">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <span class="badge">Açılış: 3.50 AZN</span>
              <span class="badge">0.40 AZN/km</span>
            </div>
            <button class="secondary" id="btnLogout" style="max-width:160px">Çıxış</button>
          </div>
          <hr />
          <div class="suggest">
            <label>Başlanğıc nöqtə</label>
            <input id="pickupInput" placeholder="Başlanğıc nöqtə (GPS və ya yaz...)" />
            <button class="secondary" id="btnPickupGPS" style="margin-top:8px">GPS ilə seç</button>
          </div>

          <div class="suggest">
            <label>Gedəcəyin yer</label>
            <input id="dropInput" placeholder="Gedəcəyin yer (yaz, alternativlər çıxsın)" />
          </div>

          <div class="row" style="margin-top:12px">
            <button class="primary" id="btnCalc">Qiyməti hesabla</button>
            <button class="secondary" id="btnOrder">Sifarişi göndər</button>
          </div>

          <p class="small" id="calcInfo"></p>
          <p class="small" id="rideInfo"></p>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div id="map"></div>
          <p class="small" style="margin-top:10px">
            İpucu: Əgər ünvanlar “şəffaf” görünürdüsə, bu versiyada kontrast artırıldı.
          </p>
        </div>
      </div>
    </div>
  </div>

  <p class="small footerlinks" style="margin-top:14px">
    <a href="driver.html">Sürücü paneli</a> • <a href="admin.html">Admin panel</a>
  </p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { mountAuth, setupSuggest, gpsToInput, calcRoute, kmFmt } from './app.js';

  document.getElementById('apiBase').textContent = (localStorage.getItem('API_BASE')||location.origin);

  mountAuth('passenger');

  let pickup=null;
  let drop=null;

  const map = L.map('map').setView([40.4093, 49.8671], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  let mPickup=null, mDrop=null;

  function setPickup(item){
    pickup={lat:item.lat, lon:item.lon, text:item.display_name};
    document.getElementById('pickupInput').value=item.display_name;
    if(mPickup) map.removeLayer(mPickup);
    mPickup=L.marker([pickup.lat,pickup.lon]).addTo(map).bindPopup('Başlanğıc');
    map.setView([pickup.lat,pickup.lon], 14);
  }
  function setDrop(item){
    drop={lat:item.lat, lon:item.lon, text:item.display_name};
    document.getElementById('dropInput').value=item.display_name;
    if(mDrop) map.removeLayer(mDrop);
    mDrop=L.marker([drop.lat,drop.lon]).addTo(map).bindPopup('Gedəcəyin yer');
    map.setView([drop.lat,drop.lon], 14);
  }

  setupSuggest(document.getElementById('pickupInput'), setPickup);
  setupSuggest(document.getElementById('dropInput'), setDrop);

  document.getElementById('btnPickupGPS').addEventListener('click', (e)=>gpsToInput(e.target, setPickup));

  document.getElementById('btnCalc').addEventListener('click', async ()=>{
    const info=document.getElementById('calcInfo');
    info.textContent='Hesablanır...';
    try{
      if(!pickup||!drop) return info.textContent='Başlanğıc və gedəcəyin yeri seç.';
      const r=await calcRoute(pickup, drop);
      info.textContent=`Məsafə: ${kmFmt(r.distance_km)} km • Təxmini qiymət: ${r.price_azn} AZN`;
    }catch(e){info.textContent='Xəta: '+e.message;}
  });

  document.getElementById('btnOrder').addEventListener('click', async ()=>{
    const info=document.getElementById('rideInfo');
    info.textContent='Sifariş göndərilir...';
    try{
      if(!pickup||!drop) return info.textContent='Başlanğıc və gedəcəyin yeri seç.';
      const r=await (await fetch((location.origin.replace(/\/$/,''))+'/api/passenger/rides'));
    }catch(e){}
    try{
      const resp = await (await import('./app.js')).api; // not exported; fallback below
    }catch{}

    try{
      const token=localStorage.getItem('token');
      const API=(localStorage.getItem('API_BASE')||'').trim()||location.origin.replace(/\/$/,'');
      const res=await fetch(API+'/api/passenger/rides',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
        body:JSON.stringify({
          pickup_lat: pickup.lat, pickup_lng: pickup.lon, pickup_text: pickup.text,
          drop_lat: drop.lat, drop_lng: drop.lon, drop_text: drop.text
        })
      });
      const data=await res.json();
      if(!res.ok) throw new Error(data.error||'order_failed');
      info.textContent = data.assigned
        ? `Sifariş yaradıldı. Sürücü təyin olundu. Ride ID: ${data.ride.id}`
        : `Sifariş yaradıldı. Hələ sürücü tapılmadı (online sürücü yoxdu). Ride ID: ${data.ride.id}`;

      // start polling
      const rideId=data.ride.id;
      const poll=async()=>{
        const r2=await fetch(API+`/api/passenger/rides/${rideId}`,{headers:{'Authorization':'Bearer '+token}});
        const d2=await r2.json();
        if(r2.ok){
          const s=d2.ride.status;
          let extra='';
          if(d2.ride.driver_name){
            extra = ` • Sürücü: ${d2.ride.driver_name} (${d2.ride.driver_phone||''}) ${d2.ride.car_model||''} ${d2.ride.car_number||''}`;
          }
          info.textContent = `Status: ${s}${extra} • Qiymət: ${d2.ride.price_azn} AZN`;
          if(!['finished','cancelled'].includes(s)) setTimeout(poll, 3000);
        }
      };
      setTimeout(poll, 1500);

    }catch(e){info.textContent='Xəta: '+e.message;}
  });

</script>
</body>
</html>
