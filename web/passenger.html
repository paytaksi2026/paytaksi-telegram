<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PayTaksi â€¢ SifariÅŸ ver</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ensure map fills */
    #map{position:fixed; inset:0;}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="sheet">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h2 style="margin:0;">PayTaksi SifariÅŸ ver</h2>
          <div style="opacity:.92; font-size:12.5px; margin-top:2px;">BaÅŸlanÄŸÄ±c vÉ™ gedÉ™cÉ™yiniz Ã¼nvanÄ± seÃ§in</div>
        </div>
        <div class="pill" id="gpsStatus">GPS: gÃ¶zlÉ™yirâ€¦</div>
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <div style="position:relative;">
          <input id="pickup" class="input" placeholder="BaÅŸlanÄŸÄ±c nÃ¶qtÉ™ (GPS ilÉ™ doldur)" autocomplete="off" />
          <div id="pickupList" class="suggest" style="display:none;"></div>
        </div>
        <div style="position:relative;">
          <input id="drop" class="input" placeholder="GedÉ™cÉ™yin yer" autocomplete="off" />
          <div id="dropList" class="suggest" style="display:none;"></div>
        </div>

        <div style="display:flex; gap:10px;">
          <button id="btnLocate" class="btn" type="button" style="flex:1; background:#2b7cff;">ğŸ“ Yerimi tap (GPS)</button>
          <button id="btnClear" class="btn" type="button" style="flex:1; background:#3a3f55;">TÉ™mizlÉ™</button>
        </div>

        <div class="kpi">
          <div class="box"><div class="label">MÉ™safÉ™</div><div class="value" id="dist">â€” km</div></div>
          <div class="box"><div class="label">QiymÉ™t</div><div class="value" id="price">â€” AZN</div></div>
          <div class="box"><div class="label">Vaxt</div><div class="value" id="eta">â€” dÉ™q</div></div>
        </div>

        <div style="display:flex; gap:10px;">
          <button id="calcBtn" class="btn" type="button" style="flex:1; background:#2b7cff;">QiymÉ™ti hesabla</button>
          <button id="orderBtn" class="btn" type="button" style="flex:1; background:#27b35a;">SifariÅŸi tÉ™sdiqlÉ™</button>
        </div>

        <div id="hint" style="font-size:12.5px; opacity:.92; line-height:1.35;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e) {}

  const $ = (id) => document.getElementById(id);

  const pickupEl = $('pickup');
  const dropEl   = $('drop');
  const pickupList = $('pickupList');
  const dropList   = $('dropList');
  const gpsStatus  = $('gpsStatus');
  const hintEl     = $('hint');

  // User id (Telegram WebApp preferred, otherwise uid query param)
  const qs = new URLSearchParams(location.search);
  const uid = qs.get('uid') || tg?.initDataUnsafe?.user?.id || '';

  const OPEN_FEE = 3.50;
  const PER_KM   = 0.40;

  let map, pickupMarker, dropMarker, routeLine;
  let pickup = null; // {lat, lon, text}
  let drop   = null;

  // Init map (Baku default)
  map = L.map('map', { zoomControl: false }).setView([40.4093, 49.8671], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const setGpsPill = (text, ok=false) => {
    gpsStatus.textContent = text;
    gpsStatus.style.background = ok ? 'rgba(39,179,90,.22)' : 'rgba(255,255,255,.10)';
    gpsStatus.style.borderColor = ok ? 'rgba(39,179,90,.35)' : 'rgba(255,255,255,.14)';
  };

  const toast = (msg) => { hintEl.textContent = msg; };

  function setMarker(which, lat, lon, text){
    const ll = [lat, lon];
    if(which === 'pickup'){
      pickup = {lat, lon, text: text || ''};
      if(!pickupMarker){ pickupMarker = L.marker(ll).addTo(map); }
      else pickupMarker.setLatLng(ll);
      if(text) pickupEl.value = text;
    } else {
      drop = {lat, lon, text: text || ''};
      if(!dropMarker){ dropMarker = L.marker(ll).addTo(map); }
      else dropMarker.setLatLng(ll);
      if(text) dropEl.value = text;
    }
  }

  async function nominatimSearch(q){
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=6&addressdetails=1&q=${encodeURIComponent(q)}`;
    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return [];
    const j = await r.json();
    return (j || []).map(x => ({
      lat: Number(x.lat),
      lon: Number(x.lon),
      label: x.display_name
    }));
  }

  async function nominatimReverse(lat, lon){
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=18&addressdetails=1&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return '';
    const j = await r.json();
    return j?.display_name || '';
  }

  function renderSuggest(box, items, onPick){
    if(!items.length){ box.style.display='none'; box.innerHTML=''; return; }
    box.innerHTML = '';
    items.forEach(it => {
      const d = document.createElement('div');
      d.textContent = it.label;
      d.style.padding = '10px 12px';
      d.style.cursor = 'pointer';
      d.onclick = () => onPick(it);
      box.appendChild(d);
    });
    box.style.display = 'block';
  }

  function debounce(fn, ms){
    let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  }

  const doPickupSuggest = debounce(async () => {
    const q = pickupEl.value.trim();
    if(q.length < 3){ renderSuggest(pickupList, [], ()=>{}); return; }
    try{
      const items = await nominatimSearch(q);
      renderSuggest(pickupList, items, async (it) => {
        renderSuggest(pickupList, [], ()=>{});
        setMarker('pickup', it.lat, it.lon, it.label);
        map.setView([it.lat,it.lon], 16);
        toast('BaÅŸlanÄŸÄ±c nÃ¶qtÉ™ seÃ§ildi. Ä°ndi gedÉ™cÉ™yiniz Ã¼nvanÄ± seÃ§in.');
      });
    }catch(e){ renderSuggest(pickupList, [], ()=>{}); }
  }, 220);

  const doDropSuggest = debounce(async () => {
    const q = dropEl.value.trim();
    if(q.length < 3){ renderSuggest(dropList, [], ()=>{}); return; }
    try{
      const items = await nominatimSearch(q);
      renderSuggest(dropList, items, async (it) => {
        renderSuggest(dropList, [], ()=>{});
        setMarker('drop', it.lat, it.lon, it.label);
        map.setView([it.lat,it.lon], 16);
        toast('GedÉ™cÉ™yiniz yer seÃ§ildi. Ä°ndi â€œQiymÉ™ti hesablaâ€ basÄ±n.');
      });
    }catch(e){ renderSuggest(dropList, [], ()=>{}); }
  }, 220);

  pickupEl.addEventListener('input', doPickupSuggest);
  dropEl.addEventListener('input', doDropSuggest);
  pickupEl.addEventListener('focus', doPickupSuggest);
  dropEl.addEventListener('focus', doDropSuggest);

  document.addEventListener('click', (e) => {
    if(!pickupList.contains(e.target) && e.target !== pickupEl) pickupList.style.display='none';
    if(!dropList.contains(e.target) && e.target !== dropEl) dropList.style.display='none';
  });

  async function locate(){
    if(!navigator.geolocation){ setGpsPill('GPS: dÉ™stÉ™klÉ™nmir'); toast('Bu cihaz GPS dÉ™stÉ™klÉ™mir. ÃœnvanÄ± É™l ilÉ™ yazÄ±n.'); return; }

    setGpsPill('GPS: icazÉ™ soruÅŸulurâ€¦');
    toast('Telefon icazÉ™ istÉ™yÉ™rsÉ™ â€œAllow/Ä°cazÉ™ verâ€ seÃ§in.');

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      setGpsPill('GPS: tapÄ±ldÄ±', true);

      map.setView([lat, lon], 16);
      setMarker('pickup', lat, lon, pickupEl.value);

      try{
        const name = await nominatimReverse(lat, lon);
        if(name){
          pickupEl.value = name;
          pickup.text = name;
        }
      }catch(e){}

      toast('GPS ilÉ™ baÅŸlanÄŸÄ±c Ã¼nvan dolduruldu. GedÉ™cÉ™yiniz Ã¼nvanÄ± yazÄ±n.');
    }, (err) => {
      setGpsPill('GPS: icazÉ™ yoxdur');
      toast('GPS icazÉ™si verilmÉ™di. Telegram/telefon ayarlarÄ±ndan Location icazÉ™sini aÃ§Ä±n vÉ™ â€œYerimi tapâ€ dÃ¼ymÉ™sini yenidÉ™n basÄ±n.');
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
  }

  $('btnLocate').onclick = locate;
  $('btnClear').onclick = () => {
    pickup = null; drop = null;
    pickupEl.value=''; dropEl.value='';
    $('dist').textContent='â€” km'; $('price').textContent='â€” AZN'; $('eta').textContent='â€” dÉ™q';
    if(pickupMarker){ map.removeLayer(pickupMarker); pickupMarker=null; }
    if(dropMarker){ map.removeLayer(dropMarker); dropMarker=null; }
    if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
    toast('TÉ™mizlÉ™ndi. Ä°stÉ™sÉ™niz â€œYerimi tapâ€ basÄ±n.');
  };

  async function calcRouteAndPrice(){
    if(!pickup || !drop){ toast('ZÉ™hmÉ™t olmasa hÉ™m baÅŸlanÄŸÄ±c, hÉ™m dÉ™ gedÉ™cÉ™yiniz Ã¼nvanÄ± seÃ§in.'); return; }

    // Try OSRM route (more accurate)
    const osrm = `https://router.project-osrm.org/route/v1/driving/${pickup.lon},${pickup.lat};${drop.lon},${drop.lat}?overview=full&geometries=geojson`;
    try{
      const r = await fetch(osrm, { headers: { 'Accept': 'application/json' } });
      if(!r.ok) throw new Error('osrm');
      const j = await r.json();
      const route = j?.routes?.[0];
      if(!route) throw new Error('no route');

      const distKm = route.distance / 1000;
      const etaMin = route.duration / 60;
      const price = Math.max(OPEN_FEE, OPEN_FEE + distKm * PER_KM);

      $('dist').textContent  = distKm.toFixed(2) + ' km';
      $('eta').textContent   = Math.max(1, Math.round(etaMin)) + ' dÉ™q';
      $('price').textContent = price.toFixed(2) + ' AZN';

      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.geoJSON(route.geometry, { style: { weight: 4, opacity: 0.9 } }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [24, 24] });

      toast(`Tarif: AÃ§Ä±lÄ±ÅŸ ${OPEN_FEE.toFixed(2)} AZN + ${PER_KM.toFixed(2)} AZN/km`);
    } catch(e){
      // Fallback: haversine approx
      const R = 6371;
      const dLat = (drop.lat - pickup.lat) * Math.PI/180;
      const dLon = (drop.lon - pickup.lon) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(pickup.lat*Math.PI/180)*Math.cos(drop.lat*Math.PI/180)*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distKm = R*c;
      const price = Math.max(OPEN_FEE, OPEN_FEE + distKm * PER_KM);

      $('dist').textContent  = distKm.toFixed(2) + ' km';
      $('eta').textContent   = 'â€”';
      $('price').textContent = price.toFixed(2) + ' AZN';
      toast('MarÅŸrut servisi aÃ§Ä±lmadÄ± (OSRM). QiymÉ™t tÉ™xmini hesablandÄ±.');
    }
  }

  $('calcBtn').onclick = calcRouteAndPrice;

  $('orderBtn').onclick = async () => {
    if(!uid){
      // user opened outside bot
      alert('ZÉ™hmÉ™t olmasa PayTaksi botundan â€œWebAppâ€ dÃ¼ymÉ™si ilÉ™ aÃ§Ä±n.');
      return;
    }
    if(!pickup || !drop){ toast('ÆvvÉ™lcÉ™ baÅŸlanÄŸÄ±c vÉ™ gedÉ™cÉ™yiniz Ã¼nvanÄ± seÃ§in.'); return; }
    await calcRouteAndPrice();

    // send data to bot (if Telegram WebApp)
    const payload = {
      uid,
      pickup,
      drop,
      price_text: $('price').textContent,
      distance_text: $('dist').textContent,
      eta_text: $('eta').textContent,
      ts: Date.now()
    };

    try{
      tg?.sendData?.(JSON.stringify(payload));
      toast('SifariÅŸ gÃ¶ndÉ™rildi. Botda tÉ™sdiq mesajÄ± gÃ¶zlÉ™yin.');
    }catch(e){
      toast('SifariÅŸ gÃ¶ndÉ™rmÉ™k alÄ±nmadÄ±. Telegram WebApp ilÉ™ aÃ§dÄ±ÄŸÄ±nÄ±za É™min olun.');
    }
  };

  // First hint
  toast('Ä°pucu: ÆgÉ™r Ã¼nvanlar â€œÅŸÉ™ffafâ€ gÃ¶rÃ¼nÃ¼rdÃ¼sÉ™, bu versiyada kontrast artÄ±rÄ±ldÄ±.');

})();
</script>
</body>
</html>
