<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayTaksi - Sifari≈ü ver</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1220; color:#e5e7eb; }
    .top { padding:12px; display:flex; gap:10px; align-items:center; background:#0f172a; position:sticky; top:0; z-index:10; }
    .pill { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:10px; flex:1; }
    input { width:100%; padding:10px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; outline:none; }
    #map { height: calc(100vh - 210px); }
    .panel { padding:12px; background:#0f172a; border-top:1px solid #1f2937; }
    .row { display:flex; gap:10px; }
    button { width:100%; padding:12px; border-radius:14px; border:0; font-weight:700; }
    .btn { background:#16a34a; color:white; }
    .btn2 { background:#334155; color:white; }
    .small { font-size:12px; color:#94a3b8; }
    .suggest { position:relative; }
    .suggest ul { position:absolute; left:0; right:0; top:44px; margin:0; padding:0; list-style:none; background:#0b1220; border:1px solid #334155; border-radius:12px; max-height:180px; overflow:auto; z-index:20; }
    .suggest li { padding:10px; border-bottom:1px solid #1f2937; cursor:pointer; }
    .suggest li:last-child{ border-bottom:0; }
  </style>
</head>
<body>
  <div class="top">
    <div style="font-weight:800;">üöï PayTaksi</div>
    <div class="small" id="status">X…ôrit…ô hazƒ±rlanƒ±r‚Ä¶</div>
  </div>

  <div class="top" style="gap:12px;">
    <div class="pill suggest">
      <div class="small">Qar≈üƒ±lama (sizin yer)</div>
      <input id="pickup" placeholder="Yerimi tap‚Ä¶" />
      <ul id="pickupSug" hidden></ul>
    </div>
    <div class="pill suggest">
      <div class="small">Haraya?</div>
      <input id="dropoff" placeholder="√únvan yaz‚Ä¶" />
      <ul id="dropoffSug" hidden></ul>
    </div>
  </div>

  <div id="map"></div>

  <div class="panel">
    <div class="row">
      <div class="pill">
        <div class="small">M…ôsaf…ô</div>
        <div id="distance">‚Äî</div>
      </div>
      <div class="pill">
        <div class="small">Qiym…ôt (t…ôxmini)</div>
        <div id="price">‚Äî</div>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="btn2" id="btnMyLoc">üìç Yerimi g√∂t√ºr</button>
      <button class="btn" id="btnOrder">‚úÖ Sifari≈ü ver</button>
    </div>
    <div style="height:8px"></div>
    <div class="small">Sifari≈üd…ôn sonra s√ºr√ºc√º tapƒ±lacaq v…ô m…ôlumatlar burada g√∂r√ºn…ôc…ôk.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch {}

    const BACKEND_URL = (new URLSearchParams(location.search)).get('backend') || (window.BACKEND_URL || 'http://localhost:3000');

    const els = {
      status: document.getElementById('status'),
      pickup: document.getElementById('pickup'),
      dropoff: document.getElementById('dropoff'),
      pickupSug: document.getElementById('pickupSug'),
      dropoffSug: document.getElementById('dropoffSug'),
      distance: document.getElementById('distance'),
      price: document.getElementById('price'),
      btnMyLoc: document.getElementById('btnMyLoc'),
      btnOrder: document.getElementById('btnOrder')
    };

    const state = {
      passengerTelegramId: tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : null,
      pickup: null,
      dropoff: null,
      orderId: null,
      driverMarkers: []
    };

    function haversineKm(a, b){
      const R=6371; const toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat); const dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat); const lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    function calcPrice(km){
      const base=2.0, perKm=0.6, min=2.8;
      const raw = base + perKm*Math.max(0, km);
      const p = Math.max(min, Math.round(raw*100)/100);
      return p;
    }

    const map = L.map('map', { zoomControl: true }).setView([40.4093, 49.8671], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const pickupMarker = L.marker([40.4093, 49.8671], { draggable: true }).addTo(map).bindPopup('Qar≈üƒ±lama');
    const dropoffMarker = L.marker([40.4093, 49.8671], { draggable: true }).addTo(map).bindPopup('Gedil…ôc…ôk');

    function setPickup(lat, lon, text){
      state.pickup = { lat, lon, text };
      pickupMarker.setLatLng([lat, lon]);
      if (text) els.pickup.value = text;
      updateEst();
    }
    function setDropoff(lat, lon, text){
      state.dropoff = { lat, lon, text };
      dropoffMarker.setLatLng([lat, lon]);
      if (text) els.dropoff.value = text;
      updateEst();
    }

    pickupMarker.on('dragend', () => {
      const p = pickupMarker.getLatLng();
      setPickup(p.lat, p.lng, els.pickup.value || null);
    });
    dropoffMarker.on('dragend', () => {
      const p = dropoffMarker.getLatLng();
      setDropoff(p.lat, p.lng, els.dropoff.value || null);
    });

    function updateEst(){
      if (!state.pickup || !state.dropoff) return;
      const km = haversineKm(state.pickup, state.dropoff);
      const price = calcPrice(km);
      els.distance.textContent = km.toFixed(1) + ' km';
      els.price.textContent = price.toFixed(2) + ' ‚Çº';
    }

    async function nominatim(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=6&countrycodes=az&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      return await res.json();
    }

    function showSug(listEl, results, onPick){
      listEl.innerHTML = '';
      for (const r of results){
        const li = document.createElement('li');
        li.textContent = r.display_name;
        li.onclick = () => { listEl.hidden = true; onPick(r); };
        listEl.appendChild(li);
      }
      listEl.hidden = results.length === 0;
    }

    let pickupT=null, dropoffT=null;
    els.pickup.addEventListener('input', () => {
      clearTimeout(pickupT);
      const q = els.pickup.value.trim();
      if (q.length < 3) { els.pickupSug.hidden=true; return; }
      pickupT=setTimeout(async () => {
        const res = await nominatim(q);
        showSug(els.pickupSug, res, (r) => setPickup(Number(r.lat), Number(r.lon), r.display_name));
      }, 350);
    });
    els.dropoff.addEventListener('input', () => {
      clearTimeout(dropoffT);
      const q = els.dropoff.value.trim();
      if (q.length < 3) { els.dropoffSug.hidden=true; return; }
      dropoffT=setTimeout(async () => {
        const res = await nominatim(q);
        showSug(els.dropoffSug, res, (r) => setDropoff(Number(r.lat), Number(r.lon), r.display_name));
      }, 350);
    });

    async function refreshDrivers(){
      try{
        const res = await fetch(`${BACKEND_URL}/api/drivers/online`);
        const data = await res.json();
        for (const m of state.driverMarkers) map.removeLayer(m);
        state.driverMarkers = [];
        for (const d of (data.drivers||[])){
          const m = L.circleMarker([d.lat, d.lon], { radius: 7 }).addTo(map);
          m.bindPopup(`üöñ ${d.full_name||'S√ºr√ºc√º'}<br>${d.car_model||''} ${d.car_plate||''}`);
          state.driverMarkers.push(m);
        }
      }catch{}
    }

    async function myLoc(){
      els.status.textContent = 'GPS axtarƒ±lƒ±r‚Ä¶';
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition((pos) => {
          const { latitude, longitude } = pos.coords;
          setPickup(latitude, longitude, 'M…ônim yerim');
          map.setView([latitude, longitude], 15);
          els.status.textContent = 'Hazƒ±rdƒ±r';
          resolve(true);
        }, () => {
          els.status.textContent = 'GPS icaz…ôsi yoxdur';
          resolve(false);
        }, { enableHighAccuracy: true, timeout: 12000 });
      });
    }

    els.btnMyLoc.onclick = myLoc;

    async function createOrder(){
      if (!state.passengerTelegramId){
        alert('Telegram ID oxunmadƒ±. Bu s…ôhif…ôni bot i√ßind…ôn a√ßƒ±n.');
        return;
      }
      if (!state.pickup || !state.dropoff){
        alert('Qar≈üƒ±lama v…ô gedil…ôc…ôk n√∂qt…ôni se√ßin.');
        return;
      }
      els.btnOrder.disabled = true;
      els.btnOrder.textContent = 'Sifari≈ü g√∂nd…ôrilir‚Ä¶';

      const body = {
        passenger_telegram_id: state.passengerTelegramId,
        pickup: state.pickup,
        dropoff: state.dropoff
      };

      const res = await fetch(`${BACKEND_URL}/api/order/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok){
        alert('X…ôta: sifari≈ü yaradƒ±lmadƒ±');
      } else {
        state.orderId = data.order_id;
        els.status.textContent = `S√ºr√ºc√º axtarƒ±lƒ±r‚Ä¶ (#${state.orderId})`;
        els.btnOrder.textContent = `‚úÖ Sifari≈ü verildi (#${state.orderId})`;
        startOrderPoll();
      }
      els.btnOrder.disabled = false;
    }

    async function startOrderPoll(){
      const id = state.orderId;
      if (!id) return;
      const timer = setInterval(async () => {
        try{
          const res = await fetch(`${BACKEND_URL}/api/order/get?order_id=${id}`);
          const data = await res.json();
          if (!data.ok) return;
          const o = data.order;
          if (o.status === 'accepted'){
            els.status.textContent = `‚úÖ S√ºr√ºc√º tapƒ±ldƒ±: ${o.driver_name||'S√ºr√ºc√º'} | ${o.car_plate||''}`;
            clearInterval(timer);
          }
          if (o.status === 'canceled'){
            els.status.textContent = '‚ùå Sifari≈ü l…ôƒüv edildi';
            clearInterval(timer);
          }
        }catch{}
      }, 2500);
    }

    els.btnOrder.onclick = createOrder;

    // init
    (async () => {
      await myLoc();
      // default dropoff near pickup so marker visible
      const p = pickupMarker.getLatLng();
      setDropoff(p.lat + 0.01, p.lng + 0.01, '');
      els.status.textContent = 'Hazƒ±rdƒ±r';
      await refreshDrivers();
      setInterval(refreshDrivers, 5000);
    })();

  </script>
</body>
</html>
