<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Passenger</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">let selectedPayMethod=null;
let selectedStars=0;

function buildStars(){
  const wrap=document.getElementById('ratingStars');
  if(!wrap) return;
  wrap.innerHTML='';
  for(let i=1;i<=5;i++){
    const b=document.createElement('button');
    b.type='button';
    b.className='starBtn';
    b.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 17.3l-5.2 2.8 1-5.9-4.2-4.1 6-0.9L12 3.8l2.4 5.4 6 .9-4.2 4.1 1 5.9z" stroke="rgba(255,255,255,.92)" stroke-width="1.6" /></svg>';
    b.onclick=()=>{
      selectedStars=i;
      [...wrap.children].forEach((x,idx)=>x.classList.toggle('on', idx < i));
      haptic('light');
    };
    wrap.appendChild(b);
  }
}
buildStars();

btnPay && (btnPay.onclick=async()=>{
  // Stripe Checkout (real payment)
  try{
    const r0 = await fetch(`${BACKEND}/api/pay/checkout`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({orderId: currentOrderId})});
    const j0 = await r0.json();
    if(j0.ok && j0.url){
      toast('√ñd…ôni≈ü','√ñd…ôni≈ü s…ôhif…ôsi a√ßƒ±lƒ±r...','success');
      haptic('light');
      window.open(j0.url, '_blank');
      selectedPayMethod='PAY';
      return;
    }
  }catch(e){}

  if(!currentOrderId) return;
  selectedPayMethod='PAY';
  toast('Pay se√ßildi','Kart/online √∂d…ôni≈ü','success');
  haptic('light');
  try{ await fetch(`${BACKEND}/api/order/${currentOrderId}/paymethod`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({method:'PAY'})}); }catch(e){}
});
btnCash && (btnCash.onclick=async()=>{
  if(!currentOrderId) return;
  selectedPayMethod='CASH';
  toast('Cash se√ßildi','Naƒüd √∂d…ôni≈ü','success');
  haptic('light');
  try{ await fetch(`${BACKEND}/api/order/${currentOrderId}/paymethod`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({method:'CASH'})}); }catch(e){}
});

btnRate && (btnRate.onclick=async()=>{
  if(!currentOrderId){ payModal.classList.remove('on'); return; }
  if(selectedStars < 1){ toast('Qiym…ôtl…ôndir','Z…ôhm…ôt olmasa 1-5 ulduz se√ß',''); haptic('light'); return; }
  setBtnLoading(btnRate,true);
  try{
    const review = (reviewText && reviewText.value) ? reviewText.value : '';
    const r = await fetch(`${BACKEND}/api/order/${currentOrderId}/rate`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({stars:selectedStars, review})});
    const j = await r.json();
    if(!j.ok){ toast('X…ôta', j.error||'G√∂nd…ôrilm…ôdi'); return; }
    toast('T…ô≈ü…ôkk√ºrl…ôr','R…ôy qeyd…ô alƒ±ndƒ±','success');
    haptic('medium');
    payModal.classList.remove('on');
  }catch(e){
    toast('X…ôta','G√∂nd…ôrilm…ôdi'); 
  }finally{
    setBtnLoading(btnRate,false,'G√∂nd…ôrildi');
  }
});
</script>
<link rel="stylesheet" href="/web/style.css"/></head>
<body>
<div class="topbar"><div class="wrap"><div class="brand"><div class="logo"></div><div><div style="font-weight:900">PayTaksi</div><div class="sub">M√º≈üt…ôri ‚Ä¢ Uber/Bolt</div></div></div><div class="pill" id="conn">üü° connecting</div></div></div>
<div id="map" class="map"></div>
<div class="sheet card"><div class="col">
<div class="row" style="justify-content:space-between"><div class="h">Sifari≈ü</div><div class="small" id="uidBox">ID: ‚Äî</div></div>
<input class="input" id="pickup" placeholder="G√∂t√ºr√ºl…ôc…ôk yer (axtar)..."/><div id="pickupList" class="list" style="display:none"></div>
<input class="input" id="dropoff" placeholder="Ged…ôc…ôyiniz yer (axtar)..."/><div id="dropList" class="list" style="display:none"></div>
<div class="kpi"><div class="box"><div class="v" id="dist">‚Äî</div><div class="l">km</div></div><div class="box"><div class="v" id="price">‚Äî</div><div class="l">AZN</div></div><div class="box"><div class="v" id="eta">‚Äî</div><div class="l">d…ôq</div></div></div>
<div class="row"><button class="btn btn-blue" id="calcBtn" style="flex:1">Qiym…ôt <span class="badgeSurge" id="surgeBadge" style="display:none">SURGE √ó<span id="surgeMult">1.0</span></span>i hesabla</button><button class="btn btn-green" id="orderBtn" style="flex:1">Sifari≈üi t…ôsdiql…ô</button></div>
<div id="orderBox" class="item" style="display:none"><div class="t" id="orderTitle"></div><div class="d" id="orderDesc"></div><div class="hr"></div><div class="small" id="orderStatus"></div></div>
</div></div>
<script>
const qs=new URLSearchParams(location.search);
const uid=qs.get("uid")||"";
uidBox.textContent="ID: "+(uid||"‚Äî");
const BACKEND=location.origin;

let currentOrderId=null;
const conn=document.getElementById("conn");
let ws;
function connectWS(){const proto=location.protocol==="https:"?"wss":"ws";ws=new WebSocket(`${proto}://${location.host}`);
ws.onopen=()=>conn.textContent="üü¢ live";
ws.onclose=()=>{conn.textContent="üü° reconnect";setTimeout(connectWS,1500)};
ws.onmessage=(ev)=>{try{const msg=JSON.parse(ev.data);
if(msg.type==="order_status" && currentOrderId===msg.orderId) showStatus(msg.status);
if(msg.type==="order_accepted" && currentOrderId===msg.order.orderId) showStatus("ACCEPTED");
}catch(e){}}}
connectWS();

const map=L.map("map",{zoomControl:false}).setView([40.4093,49.8671],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let userMarker=null;
async function reverseGeocode(lat,lon){
  const r=await fetch(`${BACKEND}/api/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
  const j=await r.json();
  return j && j.ok ? j.display_name : "";
}

// Auto-detect current location and fill pickup after permission
navigator.geolocation.getCurrentPosition(async p=>{
  const lat=p.coords.latitude, lon=p.coords.longitude;
  map.setView([lat,lon],15);
  if(userMarker) userMarker.remove();
  userMarker=L.circleMarker([lat,lon],{radius:8,weight:2,opacity:1,fillOpacity:0.9}).addTo(map);
  const name=await reverseGeocode(lat,lon);
  if(name){
    pickup.value=name;
    pickupSel={lat,lon,display:name};
  }else{
    pickupSel={lat,lon,display:""};
  }
},()=>{});

let pickupSel=null, dropSel=null;
let activeField="pickup";

pickup.addEventListener('focus',()=>activeField='pickup');
dropoff.addEventListener('focus',()=>activeField='dropoff');

// Tap on map to choose locations quickly
map.on('click', async (e)=>{
  const lat=e.latlng.lat, lon=e.latlng.lng;
  const name=await reverseGeocode(lat,lon);
  const label=name||`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  if(activeField==='dropoff'){
    dropoff.value=label;
    dropSel={lat,lon,display:label};
  }else{
    pickup.value=label;
    pickupSel={lat,lon,display:label};
  }
});

async function geocode(q){
  const r=await fetch(`${BACKEND}/api/geocode?q=`+encodeURIComponent(q));
  const j=await r.json();
  return (j && j.ok && Array.isArray(j.items)) ? j.items : [];
}

function renderList(el,items,onPick){
  el.style.display=items.length?"block":"none";
  el.innerHTML="";
  items.forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    const display=it.display_name || "";
    d.innerHTML=`<div class="t">${(display.split(",")[0]||display)}</div><div class="d">${display}</div>`;
    d.onclick=()=>onPick({lat:it.lat,lon:it.lon,display});
    el.appendChild(d);
  });
}
let t1,t2;
pickup.oninput=()=>{activeField='pickup'; clearTimeout(t1);const v=pickup.value.trim();if(v.length<3){pickupList.style.display="none";return;}
t1=setTimeout(async()=>{renderList(pickupList,await geocode(v),(it)=>{pickupSel={lat:it.lat,lon:it.lon,display:it.display};pickup.value=it.display;pickupList.style.display="none";map.setView([it.lat,it.lon],16);});},250);};
dropoff.oninput=()=>{activeField='dropoff'; clearTimeout(t2);const v=dropoff.value.trim();if(v.length<3){dropList.style.display="none";return;}
t2=setTimeout(async()=>{renderList(dropList,await geocode(v),(it)=>{dropSel={lat:it.lat,lon:it.lon,display:it.display};dropoff.value=it.display;dropList.style.display="none";map.setView([it.lat,it.lon],16);});},250);};

// Hide lists when tapping elsewhere
document.addEventListener('click',(e)=>{
  if(!pickup.contains(e.target) && !pickupList.contains(e.target)) pickupList.style.display='none';
  if(!dropoff.contains(e.target) && !dropList.contains(e.target)) dropList.style.display='none';
});

async function calc(){if(!pickupSel||!dropSel){alert("Pickup v…ô Dropoff se√ßin.");return null;}
const r=await fetch(`${BACKEND}/api/route`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({pickup:pickupSel,dropoff:dropSel})});
const j=await r.json();if(!j.ok){alert("Hesablama x…ôtasƒ±");return null;}
dist.textContent=j.distanceKm.toFixed(2);price.textContent=j.price.toFixed(2);eta.textContent=String(j.durationMin);return j;}
calcBtn.onclick=calc;

function showOrder(o){currentOrderId=o.orderId;orderBox.style.display="block";orderTitle.textContent="Sifari≈ü #"+o.orderId;orderDesc.textContent=`${o.distanceKm} km ‚Ä¢ ${o.price} AZN`;showStatus(o.status);}
function showStatus(st){orderStatus.textContent="Status: "+st;}

orderBtn.onclick=async()=>{if(!uid){alert("Botdan WebApp d√ºym…ôsi il…ô a√ßƒ±n.");return;}if(!pickupSel||!dropSel){alert("Pickup v…ô Dropoff se√ßin.");return;}
await calc();const r=await fetch(`${BACKEND}/api/order`,{method:"POST",headers:{"content-type":"application/json"},
body:JSON.stringify({passengerId:uid,pickup:pickupSel,dropoff:dropSel,note:""})});
const j=await r.json();if(!j.ok){alert(j.error||"Sifari≈ü x…ôtasƒ±");return;}showOrder(j.order);};
</script>
</body></html>
