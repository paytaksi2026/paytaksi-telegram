<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Admin ‚Ä¢ <span class="small" id="surgeInfo"></span></title><link rel="stylesheet" href="/web/style.css"/></head>
<body>
<div class="topbar"><div class="wrap"><div class="brand"><div class="logo"></div><div><div style="font-weight:900">PayTaksi</div><div class="sub">Admin ‚Ä¢ Live</div></div></div><div class="pill" id="conn">üü° connecting</div></div></div>
<div style="padding-top:64px;max-width:760px;margin:0 auto;padding:12px">
<div class="card" style="padding:12px"><div class="h">Monitor</div><div class="sub">S√ºr√ºc√ºl…ôr v…ô sifari≈ül…ôr</div><div class="hr"></div>
<div class="kpi"><div class="box"><div class="v" id="dCount">0</div><div class="l">Aktiv s√ºr√ºc√º</div></div><div class="box"><div class="v" id="oCount">0</div><div class="l">Sifari≈ü</div></div><div class="box"><div class="v" id="sCount">0</div><div class="l">Axtarƒ±≈üda</div></div></div></div>
<div class="card" style="padding:12px;margin-top:12px"><div class="h">S√ºr√ºc√ºl…ôr</div><div class="list" id="drivers"></div></div>
<div class="card" style="padding:12px;margin-top:12px;margin-bottom:20px"><div class="h">Sifari≈ül…ôr</div><div class="list" id="orders"></div></div>
</div>
<script>
const conn=document.getElementById("conn");let drivers=[], orders=[];
function draw(){
  dCount.textContent=drivers.filter(d=>d.online).length;
  oCount.textContent=orders.length;
  sCount.textContent=orders.filter(o=>o.status==="SEARCHING").length;
  driversEl.innerHTML="";
  drivers.slice(0,20).forEach(d=>{
    const div=document.createElement("div");div.className="item";
    div.innerHTML=`<div class="t">#${d.driverId} ${d.online?"üü¢":"üî¥"}</div><div class="d">${(d.lat||0).toFixed(5)}, ${(d.lon||0).toFixed(5)}<br/>${new Date(d.ts||0).toLocaleString()}</div>`;
    driversEl.appendChild(div);
  });
  ordersEl.innerHTML="";
  orders.slice().sort((a,b)=>b.createdAt-a.createdAt).slice(0,20).forEach(o=>{
    const div=document.createElement("div");div.className="item";
    div.innerHTML=`<div class="t">#${o.orderId} ‚Ä¢ ${o.price} AZN ‚Ä¢ ${o.status}</div><div class="d">P:${o.passengerId} ‚Ä¢ D:${o.driverId||"‚Äî"}<br/>${o.pickup.display||""}<br/>‚Üí ${o.dropoff.display||""}</div>`;
    ordersEl.appendChild(div);
  });
}
const driversEl=document.getElementById("drivers");const ordersEl=document.getElementById("orders");
let ws;
function connectWS(){
  const proto=location.protocol==="https:"?"wss":"ws";
  ws=new WebSocket(`${proto}://${location.host}`);
  ws.onopen=()=>conn.textContent="üü¢ live";
  ws.onclose=()=>{conn.textContent="üü° reconnect";setTimeout(connectWS,1500)};
  ws.onmessage=(ev)=>{
    try{
      const msg=JSON.parse(ev.data);
      if(msg.type==="drivers_snapshot"){drivers=msg.drivers;draw();}
      if(msg.type==="orders_snapshot"){orders=msg.orders;draw();}
      if(msg.type==="driver"){
        const i=drivers.findIndex(x=>String(x.driverId)===String(msg.driverId));
        const obj={driverId:msg.driverId,...msg.data};
        if(i>=0) drivers[i]=obj; else drivers.unshift(obj);
        draw();
      }
      if(msg.type==="order_created"){orders.unshift(msg.order);draw();}
      if(msg.type==="order_accepted"){
        const i=orders.findIndex(x=>x.orderId===msg.order.orderId);
        if(i>=0) orders[i]=msg.order; else orders.unshift(msg.order);
        draw();
      }
      if(msg.type==="order_status"){
        const i=orders.findIndex(x=>x.orderId===msg.orderId);
        if(i>=0){orders[i].status=msg.status;draw();}
      }
    }catch(e){}
  };
}
connectWS();
</script>
<script>
const BACKEND=location.origin;
let ADMIN_KEY = localStorage.getItem("ADMIN_KEY") || "";
function adminFetch(url, opts={}){
  opts.headers = opts.headers || {};
  if(ADMIN_KEY) opts.headers["x-admin-key"]=ADMIN_KEY;
  return fetch(url, opts);
}
function promptAdminKey(){
  const k = prompt("Admin KEY (Render ENV ADMIN_KEY):", ADMIN_KEY||"");
  if(k!==null){ ADMIN_KEY = k.trim(); localStorage.setItem("ADMIN_KEY", ADMIN_KEY); toast("Saxlanƒ±ldƒ±","Admin key yadda saxlanƒ±ldƒ±","success"); }
}
</script>
<div class="card" style="margin:12px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <div style="font-weight:900">Driver Approvals</div>
    <div style="display:flex;gap:8px">
      <button class="btn" type="button" onclick="promptAdminKey()">Admin Key</button>
      <button class="btn btn-blue" id="drvReload" type="button">Yenil…ô</button>
    </div>
  </div>
  <div class="small" style="margin-top:6px">Pending / Rejected s√ºr√ºc√ºl…ôri t…ôsdiql…ô v…ô ya r…ôdd et</div>
  <div id="drvList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px"></div>
</div>

<script>
async function loadDrivers(){
  const box=document.getElementById('drvList');
  box.innerHTML='';
  const r=await adminFetch(`${BACKEND}/api/admin/drivers`);
  const j=await r.json();
  if(!j.ok){ toast("X…ôta", j.error||"admin auth"); return; }
  const drivers=j.drivers||[];
  drivers.forEach(d=>{
    const st = d.status || (d.approved ? "APPROVED" : "PENDING");
    const card=document.createElement('div');
    card.className='card';
    card.style.margin='0';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div>
          <div style="font-weight:900">${d.full_name||"‚Äî"} <span class="small">(${d.driver_id})</span></div>
          <div class="small">${d.phone||""} ‚Ä¢ ${d.car_model||""} ‚Ä¢ ${d.car_plate||""} ‚Ä¢ ${d.car_color||""}</div>
          <div class="small">Status: <b>${st}</b> ${d.rejected_reason?("‚Ä¢ S…ôb…ôb: "+d.rejected_reason):""}</div>
          <div class="small" style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            ${d.license_photo?`<a class="btn" target="_blank" href="${d.license_photo}">License</a>`:""}
            ${d.car_photo?`<a class="btn" target="_blank" href="${d.car_photo}">Car</a>`:""}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-green">Approve</button>
          <button class="btn btn-red">Reject</button>
        </div>
      </div>
    `;
    const [btnA, btnR] = card.querySelectorAll('button');
    btnA.onclick = async()=>{
      const rr=await adminFetch(`${BACKEND}/api/admin/driver/approve`,{method:'POST',headers:{'content-type':'application/json','x-admin-key':ADMIN_KEY},body:JSON.stringify({driverId:d.driver_id})});
      const jj=await rr.json();
      if(jj.ok){ toast("OK","T…ôsdiql…ôndi","success"); loadDrivers(); } else toast("X…ôta", jj.error||"");
    };
    btnR.onclick = async()=>{
      const reason = prompt("Reject s…ôb…ôbi:", d.rejected_reason||"");
      if(reason===null) return;
      const rr=await adminFetch(`${BACKEND}/api/admin/driver/reject`,{method:'POST',headers:{'content-type':'application/json','x-admin-key':ADMIN_KEY},body:JSON.stringify({driverId:d.driver_id, reason})});
      const jj=await rr.json();
      if(jj.ok){ toast("OK","R…ôdd edildi","success"); loadDrivers(); } else toast("X…ôta", jj.error||"");
    };
    box.appendChild(card);
  });
}
document.getElementById('drvReload')?.addEventListener('click', loadDrivers);
setTimeout(loadDrivers, 300);
</script>

</body></html>
